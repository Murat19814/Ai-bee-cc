{% extends "base.html" %}

{% block title %}DATENBANK - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.database-page { padding: 1.5rem; }

/* Page Header */
.page-header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.page-title-section h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-title-section h1 i { color: #9C27B0; }

.page-title-section p {
    margin: 0.25rem 0 0 0;
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Toolbar */
.toolbar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.toolbar-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.9rem;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--text-color);
    transition: all 0.2s;
}

.toolbar-btn:hover {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.toolbar-btn.primary {
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    border-color: #4CAF50;
    color: white;
}

.toolbar-btn.danger { color: #f44336; }
.toolbar-btn.danger:hover { background: #f44336; border-color: #f44336; color: white; }

.toolbar-divider {
    width: 1px;
    height: 28px;
    background: var(--border-color);
    margin: 0 0.5rem;
}

/* Dropdown Menu */
.dropdown-wrapper {
    position: relative;
    display: inline-block;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: #1e1e2d;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    min-width: 220px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
}

.dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(5px);
}

.dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: #e0e0e0;
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.dropdown-menu a:first-child {
    border-radius: 10px 10px 0 0;
}

.dropdown-menu a:last-child {
    border-radius: 0 0 10px 10px;
}

.dropdown-menu a:hover {
    background: rgba(156, 39, 176, 0.2);
    color: #fff;
}

.dropdown-menu a i {
    font-size: 1.1rem;
    color: #9C27B0;
}

.dropdown-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 0.25rem 0;
}

/* Tab Navigation */
.tab-nav {
    display: flex;
    gap: 0;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
}

.tab-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 0.95rem;
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn:hover { color: var(--text-color); }

.tab-btn.active {
    color: var(--primary-color);
    font-weight: 600;
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-color);
}

.tab-badge {
    background: var(--primary-color);
    color: white;
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
}

.tab-badge.inactive { background: #9e9e9e; }

/* Data Table */
.data-table-container {
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    padding: 0.9rem 0.75rem;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: left;
    white-space: nowrap;
    position: sticky;
    top: 0;
}

.data-table th:first-child { border-radius: 12px 0 0 0; }
.data-table th:last-child { border-radius: 0 12px 0 0; }

.data-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9rem;
}

.data-table tbody tr {
    transition: all 0.2s;
}

.data-table tbody tr:hover {
    background: rgba(156, 39, 176, 0.05);
}

.data-table tbody tr.selected {
    background: rgba(156, 39, 176, 0.1);
}

/* Row checkbox */
.row-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* ID column */
.id-cell {
    font-weight: 600;
    color: var(--primary-color);
}

/* Name column */
.name-cell {
    font-weight: 500;
    color: #2196F3;
    cursor: pointer;
}

.name-cell:hover { text-decoration: underline; }

/* Campaign badge */
.campaign-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.3rem 0.6rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Stats columns */
.stat-new { color: #4CAF50; font-weight: 600; }
.stat-total { color: var(--text-muted); }
.stat-calling { color: #2196F3; font-weight: 600; }
.stat-sales { color: #FF9800; font-weight: 700; }

/* Status toggle */
.status-toggle {
    position: relative;
    width: 40px;
    height: 22px;
}

.status-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.status-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #ccc;
    border-radius: 22px;
    transition: 0.3s;
}

.status-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
}

.status-toggle input:checked + .status-slider {
    background: #4CAF50;
}

.status-toggle input:checked + .status-slider:before {
    transform: translateX(18px);
}

/* Date column */
.date-cell {
    font-size: 0.85rem;
    white-space: nowrap;
}

.date-cell .date { color: var(--text-color); }
.date-cell .time { color: var(--text-muted); font-size: 0.8rem; }

/* Action buttons */
.action-btns {
    display: flex;
    gap: 0.3rem;
}

.action-btn {
    width: 30px;
    height: 30px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: var(--text-muted);
}

.action-btn:hover {
    background: var(--primary-color);
    color: white;
}

.action-btn.danger:hover { background: #f44336; }
.action-btn.success:hover { background: #4CAF50; }
.action-btn.info:hover { background: #2196F3; }

/* Empty state */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

/* Statistics Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: #1e1e2d;
    border-radius: 16px;
    width: 95%;
    max-width: 1100px;
    max-height: 90vh;
    overflow: hidden;
    transform: scale(0.9);
    transition: all 0.3s;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
}

.modal-overlay.active .modal-content {
    transform: scale(1);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
}

.modal-close {
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.modal-close:hover { background: #f44336; }

.modal-body {
    padding: 1.5rem;
    max-height: calc(90vh - 80px);
    overflow-y: auto;
    background: #1e1e2d;
    color: #e0e0e0;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: #252536;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-card .stat-label {
    font-size: 0.85rem;
    color: #9e9e9e;
    margin-bottom: 0.5rem;
    margin-top: 0.75rem;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
}

.stat-card .stat-sub {
    font-size: 0.8rem;
    color: #757575;
    margin-top: 0.25rem;
}

.stat-card.green .stat-value { color: #4CAF50; }
.stat-card.orange .stat-value { color: #FF9800; }
.stat-card.blue .stat-value { color: #2196F3; }
.stat-card.red .stat-value { color: #f44336; }
.stat-card.purple .stat-value { color: #9C27B0; }

/* Progress Ring */
.progress-ring-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.progress-ring {
    width: 80px;
    height: 80px;
    position: relative;
}

.progress-ring svg {
    transform: rotate(-90deg);
}

.progress-ring .progress-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 8;
}

.progress-ring .progress-fill {
    fill: none;
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
}

.progress-ring .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1rem;
    font-weight: 700;
}

/* Dispositions Table */
.disposition-table {
    width: 100%;
    border-collapse: collapse;
    background: #252536;
    border-radius: 12px;
    overflow: hidden;
}

.disposition-table th,
.disposition-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.disposition-table th {
    background: #1a1a2e;
    font-weight: 600;
    font-size: 0.85rem;
    color: #fff;
}

.disposition-table .dispo-name {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.disposition-table .dispo-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.disposition-table .count-cell {
    font-weight: 600;
    color: #2196F3;
}

.disposition-table .percent-cell {
    color: var(--text-muted);
}

/* Upload Panel */
.upload-panel {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 1.5rem;
    color: white;
    margin-bottom: 1.5rem;
}

.upload-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.upload-left h4 {
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.upload-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.4rem;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.7);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.6rem 0.75rem;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 0.9rem;
}

.form-group input::placeholder { color: rgba(255,255,255,0.5); }
.form-group select option { background: #1a1a2e; color: white; }

.file-drop-zone {
    border: 2px dashed rgba(255,255,255,0.3);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.file-drop-zone:hover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.file-drop-zone i {
    font-size: 2.5rem;
    color: #4CAF50;
    margin-bottom: 0.75rem;
}

.file-drop-zone input { display: none; }

.selected-file-info {
    background: rgba(76, 175, 80, 0.2);
    border: 1px solid #4CAF50;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    display: none;
    align-items: center;
    justify-content: space-between;
    margin-top: 1rem;
}

.selected-file-info.show { display: flex; }

.upload-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.25rem;
}

.btn-analyze {
    flex: 1;
    padding: 0.75rem;
    border: none;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-analyze.primary {
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
}

.btn-analyze.confirm {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.btn-analyze.cancel {
    background: linear-gradient(135deg, #f44336, #D32F2F);
    color: white;
}

.btn-analyze:hover { transform: translateY(-2px); }
.btn-analyze:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

/* Analysis Results */
.analysis-results {
    display: none;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.analysis-results.show { display: block; }

.analysis-stats {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
}

.analysis-stat {
    text-align: center;
    padding: 0.75rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}

.analysis-stat .value {
    font-size: 1.5rem;
    font-weight: 700;
}

.analysis-stat .label {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.6);
    margin-top: 0.25rem;
}

.analysis-stat.green .value { color: #4CAF50; }
.analysis-stat.blue .value { color: #2196F3; }
.analysis-stat.orange .value { color: #FF9800; }
.analysis-stat.red .value { color: #f44336; }
.analysis-stat.purple .value { color: #9C27B0; }

/* Pagination */
.pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-top: 1px solid var(--border-color);
}

.pagination-info {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.pagination-btns {
    display: flex;
    gap: 0.25rem;
}

.pagination-btn {
    min-width: 36px;
    height: 36px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    border-radius: 6px;
    cursor: pointer;
    color: var(--text-color);
    font-size: 0.9rem;
    transition: all 0.2s;
}

.pagination-btn:hover,
.pagination-btn.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

/* Responsive */
@media (max-width: 1200px) {
    .upload-grid { grid-template-columns: 1fr; }
    .analysis-stats { grid-template-columns: repeat(3, 1fr); }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
    .toolbar { flex-wrap: wrap; }
    .tab-btn { padding: 0.5rem 1rem; font-size: 0.85rem; }
    .analysis-stats { grid-template-columns: repeat(2, 1fr); }
}

@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="database-page">
    <!-- Page Header -->
    <div class="page-header-bar">
        <div class="page-title-section">
            <h1>
                <i class="ti ti-database"></i>
                <span data-tr="DATENBANK" data-de="DATENBANK">DATENBANK</span>
            </h1>
            <p data-tr="Müşteri verilerini yönetin, yükleyin ve analiz edin" data-de="Kundendaten verwalten, hochladen und analysieren">Müşteri verilerini yönetin, yükleyin ve analiz edin</p>
        </div>
        
        <div class="toolbar">
            <button class="toolbar-btn primary" onclick="toggleUploadPanel()">
                <i class="ti ti-upload"></i>
                <span data-tr="Yeni Yükle" data-de="Neu hochladen">Yeni Yükle</span>
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" onclick="editSelected()">
                <i class="ti ti-edit"></i>
                <span data-tr="Düzenle" data-de="Bearbeiten">Düzenle</span>
            </button>
            <button class="toolbar-btn danger" onclick="deleteSelected()">
                <i class="ti ti-trash"></i>
                <span data-tr="Sil" data-de="Löschen">Sil</span>
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" onclick="downloadSelected()">
                <i class="ti ti-download"></i>
                <span data-tr="İndir" data-de="Download">İndir</span>
            </button>
            <button class="toolbar-btn" onclick="showProcesses()">
                <i class="ti ti-chart-bar"></i>
                <span data-tr="Prosesler" data-de="Prozesse">Prosesler</span>
            </button>
            
            <!-- Options Dropdown -->
            <div class="dropdown-wrapper">
                <button class="toolbar-btn" onclick="toggleOptionsMenu()">
                    <i class="ti ti-settings"></i>
                    <span data-tr="Seçenekler" data-de="Optionen">Seçenekler</span>
                    <i class="ti ti-chevron-down" style="font-size: 0.75rem; margin-left: 0.25rem;"></i>
                </button>
                <div class="dropdown-menu" id="optionsMenu">
                    <a href="#" onclick="batchDataStats(); return false;">
                        <i class="ti ti-chart-pie"></i>
                        <span data-tr="Veri İstatistikleri" data-de="Datenstatistik">Veri İstatistikleri</span>
                    </a>
                    <a href="#" onclick="batchProcess(); return false;">
                        <i class="ti ti-stack-2"></i>
                        <span data-tr="Toplu İşlem" data-de="Batch-Prozesse">Toplu İşlem</span>
                    </a>
                    <a href="#" onclick="showTransactionPlan(); return false;">
                        <i class="ti ti-calendar-event"></i>
                        <span data-tr="İşlem Planı" data-de="Transaktionsplan">İşlem Planı</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" onclick="batchStatusUpdate(); return false;">
                        <i class="ti ti-refresh"></i>
                        <span data-tr="Durumu Güncelle" data-de="Status aktualisieren">Durumu Güncelle</span>
                    </a>
                    <a href="#" onclick="copySelectedData(); return false;">
                        <i class="ti ti-copy"></i>
                        <span data-tr="Kopyala" data-de="Kopieren">Kopyala</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" onclick="resetQueue(); return false;">
                        <i class="ti ti-player-stop"></i>
                        <span data-tr="Kuyruğu Sıfırla" data-de="Warteschlange zurücksetzen">Kuyruğu Sıfırla</span>
                    </a>
                </div>
            </div>
            
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" onclick="refreshData()">
                <i class="ti ti-refresh"></i>
                <span data-tr="Yenile" data-de="Aktualisieren">Yenile</span>
            </button>
        </div>
    </div>

    <!-- Upload Panel (Hidden by default) -->
    <div class="upload-panel" id="uploadPanel" style="display: none;">
        <div class="upload-grid">
            <div class="upload-left">
                <h4><i class="ti ti-database-import"></i> <span data-tr="Veri Yükleme Merkezi" data-de="Datenupload-Zentrum">Veri Yükleme Merkezi</span></h4>
                
                <div class="upload-form-grid">
                    <div class="form-group">
                        <label data-tr="Veri Adı *" data-de="Datenname *">Veri Adı *</label>
                        <input type="text" id="dataName" placeholder="Örn: BS-Rn-10_15-kasim">
                    </div>
                    <div class="form-group">
                        <label data-tr="Kampanya" data-de="Kampagne">Kampanya</label>
                        <select id="campaignSelect">
                            <option value="">-- Kampanya Seçin (Opsiyonel) --</option>
                            {% for campaign in campaigns %}
                            <option value="{{ campaign.id }}">{{ campaign.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-tr="Dublet Kontrolü" data-de="Duplikat-Abgleich">Dublet Kontrolü</label>
                        <select id="duplicateCheck">
                            <option value="own" data-tr="Sadece kendi verilerim" data-de="Nur eigene Daten">Sadece kendi verilerim</option>
                            <option value="all" data-tr="Tüm sistem verileri" data-de="Alle Systemdaten">Tüm sistem verileri</option>
                            <option value="none" data-tr="Kontrol etme" data-de="Nicht prüfen">Kontrol etme</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-tr="Öncelik" data-de="Priorität">Öncelik</label>
                        <select id="prioritySelect">
                            <option value="normal">Normal</option>
                            <option value="high" data-tr="Yüksek" data-de="Hoch">Yüksek</option>
                            <option value="low" data-tr="Düşük" data-de="Niedrig">Düşük</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="upload-right">
                <div class="file-drop-zone" onclick="document.getElementById('fileInput').click()" id="dropZone">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
                    <i class="ti ti-cloud-upload"></i>
                    <p data-tr="Excel/CSV dosyasını sürükleyin veya seçin" data-de="Excel/CSV Datei hierher ziehen oder auswählen">Excel/CSV dosyasını sürükleyin veya seçin</p>
                    <small style="color: rgba(255,255,255,0.5);">.xlsx, .xls, .csv</small>
                </div>
                
                <div class="selected-file-info" id="selectedFile">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="ti ti-file-spreadsheet" style="font-size: 1.5rem; color: #4CAF50;"></i>
                        <div>
                            <div id="fileName" style="font-weight: 600;">-</div>
                            <div id="fileSize" style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">-</div>
                        </div>
                    </div>
                    <button onclick="removeFile()" style="background: none; border: none; color: #f44336; cursor: pointer; font-size: 1.2rem;">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="upload-actions" id="uploadActions">
            <button class="btn-analyze primary" id="analyzeBtn" onclick="analyzeFile()">
                <i class="ti ti-search"></i>
                <span data-tr="Dosyayı Analiz Et" data-de="Datei analysieren">Dosyayı Analiz Et</span>
            </button>
        </div>
        
        <!-- Analysis Results -->
        <div class="analysis-results" id="analysisResults">
            <div class="analysis-stats">
                <div class="analysis-stat purple">
                    <div class="value" id="statTotal">0</div>
                    <div class="label" data-tr="Toplam" data-de="Gesamt">Toplam</div>
                </div>
                <div class="analysis-stat green">
                    <div class="value" id="statValid">0</div>
                    <div class="label" data-tr="Geçerli" data-de="Gültig">Geçerli</div>
                </div>
                <div class="analysis-stat orange">
                    <div class="value" id="statDuplicate">0</div>
                    <div class="label" data-tr="Dublet" data-de="Duplikate">Dublet</div>
                </div>
                <div class="analysis-stat red">
                    <div class="value" id="statBlacklist">0</div>
                    <div class="label">Blacklist</div>
                </div>
                <div class="analysis-stat blue">
                    <div class="value" id="statIban">0</div>
                    <div class="label" data-tr="IBAN'lı" data-de="Mit IBAN">IBAN'lı</div>
                </div>
                <div class="analysis-stat red">
                    <div class="value" id="statError">0</div>
                    <div class="label" data-tr="Hatalı" data-de="Fehlerhaft">Hatalı</div>
                </div>
            </div>
            
            <div class="upload-actions" style="margin-top: 1rem;">
                <button class="btn-analyze confirm" onclick="confirmImport()">
                    <i class="ti ti-check"></i>
                    <span data-tr="Onayla ve Kaydet" data-de="Bestätigen und speichern">Onayla ve Kaydet</span>
                </button>
                <button class="btn-analyze cancel" onclick="cancelImport()">
                    <i class="ti ti-x"></i>
                    <span data-tr="İptal Et" data-de="Abbrechen">İptal Et</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('active')">
            <i class="ti ti-database"></i>
            <span data-tr="Aktif Veriler" data-de="Aktive Daten">Aktif Veriler</span>
            <span class="tab-badge" id="activeCount">{{ lists|length if lists else 0 }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('inactive')">
            <i class="ti ti-archive"></i>
            <span data-tr="Pasif Veriler" data-de="Inaktive Daten">Pasif Veriler</span>
            <span class="tab-badge inactive" id="inactiveCount">0</span>
        </button>
    </div>

    <!-- Active Data Tab -->
    <div class="tab-content" id="activeTab">
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="row-checkbox" onchange="toggleAllRows(this)"></th>
                        <th>ID</th>
                        <th data-tr="Ad" data-de="Name">Ad</th>
                        <th data-tr="Kampanya" data-de="Kampagne">Kampanya</th>
                        <th data-tr="Yeni/Toplam" data-de="Neu/Gesamt">Yeni/Toplam</th>
                        <th data-tr="Aramada" data-de="in Anruf">Aramada</th>
                        <th data-tr="Satış" data-de="Verkauf">Satış</th>
                        <th data-tr="Tarih" data-de="Datum">Tarih</th>
                        <th data-tr="Aktif?" data-de="Aktiv?">Aktif?</th>
                        <th data-tr="İşlem" data-de="Aktion">İşlem</th>
                    </tr>
                </thead>
                <tbody id="activeDataBody">
                    {% if lists %}
                    {% for list in lists %}
                    <tr data-id="{{ list.id }}">
                        <td><input type="checkbox" class="row-checkbox" value="{{ list.id }}"></td>
                        <td class="id-cell">{{ list.id }}</td>
                        <td class="name-cell" onclick="showDataStats({{ list.id }}, '{{ list.name }}')">{{ list.name }}</td>
                        <td>
                            <span class="campaign-badge">
                                <i class="ti ti-speakerphone"></i>
                                {{ list.campaign.name if list.campaign else 'Atanmadı' }}
                            </span>
                        </td>
                        <td>
                            <span class="stat-new">{{ list.new_records or 0 }}</span>/<span class="stat-total">{{ list.total_records or 0 }}</span>
                        </td>
                        <td class="stat-calling">{{ list.in_call or 0 }}</td>
                        <td class="stat-sales">{{ list.sales or 0 }}</td>
                        <td class="date-cell">
                            <div class="date">{{ list.created_at.strftime('%d.%m.%Y') }}</div>
                            <div class="time">{{ list.created_at.strftime('%H:%M') }}</div>
                        </td>
                        <td>
                            <label class="status-toggle">
                                <input type="checkbox" {{ 'checked' if list.status == 'active' else '' }} onchange="toggleStatus({{ list.id }}, this.checked)">
                                <span class="status-slider"></span>
                            </label>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn info" title="İstatistik" onclick="showDataStats({{ list.id }}, '{{ list.name }}')">
                                    <i class="ti ti-chart-pie"></i>
                                </button>
                                <button class="action-btn" title="Prosesler" onclick="showDataProcesses({{ list.id }})">
                                    <i class="ti ti-list-check"></i>
                                </button>
                                <button class="action-btn success" title="İndir" onclick="downloadData({{ list.id }})">
                                    <i class="ti ti-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="ti ti-database-off"></i>
                            <p data-tr="Henüz veri yüklenmemiş" data-de="Noch keine Daten hochgeladen">Henüz veri yüklenmemiş</p>
                            <button class="toolbar-btn primary" onclick="toggleUploadPanel()" style="margin-top: 1rem;">
                                <i class="ti ti-upload"></i> <span data-tr="Veri Yükle" data-de="Daten hochladen">Veri Yükle</span>
                            </button>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            
            <div class="pagination">
                <div class="pagination-info">
                    <span data-tr="Toplam" data-de="Gesamt">Toplam</span> <strong id="totalRecords">{{ lists|length if lists else 0 }}</strong> <span data-tr="kayıt" data-de="Einträge">kayıt</span>
                </div>
                <div class="pagination-btns">
                    <button class="pagination-btn"><i class="ti ti-chevron-left"></i></button>
                    <button class="pagination-btn active">1</button>
                    <button class="pagination-btn">2</button>
                    <button class="pagination-btn">3</button>
                    <button class="pagination-btn"><i class="ti ti-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inactive Data Tab -->
    <div class="tab-content" id="inactiveTab" style="display: none;">
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="row-checkbox"></th>
                        <th>ID</th>
                        <th data-tr="Ad" data-de="Name">Ad</th>
                        <th data-tr="Kampanya" data-de="Kampagne">Kampanya</th>
                        <th data-tr="Yeni/Toplam" data-de="Neu/Gesamt">Yeni/Toplam</th>
                        <th data-tr="Aramada" data-de="in Anruf">Aramada</th>
                        <th data-tr="Satış" data-de="Verkauf">Satış</th>
                        <th data-tr="Tarih" data-de="Datum">Tarih</th>
                        <th data-tr="İşlem" data-de="Aktion">İşlem</th>
                    </tr>
                </thead>
                <tbody id="inactiveDataBody">
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="ti ti-archive-off"></i>
                            <p data-tr="Pasif veri bulunmuyor" data-de="Keine inaktiven Daten">Pasif veri bulunmuyor</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Data Statistics Modal -->
<div class="modal-overlay" id="statsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="ti ti-chart-pie"></i> <span data-tr="Veri İstatistikleri" data-de="Datenstatistik">Veri İstatistikleri</span>: <span id="statsDataName">-</span></h3>
            <button class="modal-close" onclick="closeModal('statsModal')"><i class="ti ti-x"></i></button>
        </div>
        <div class="modal-body">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="progress-ring-container">
                        <div class="progress-ring">
                            <svg width="80" height="80">
                                <circle class="progress-bg" cx="40" cy="40" r="32"></circle>
                                <circle class="progress-fill" cx="40" cy="40" r="32" stroke="#4CAF50" stroke-dasharray="201" stroke-dashoffset="180"></circle>
                            </svg>
                            <span class="progress-text" style="color: #4CAF50;">11%</span>
                        </div>
                        <div class="stat-label" data-tr="Cevaplanan / Aramada" data-de="Antwortete / in Anruf">Cevaplanan / Aramada</div>
                        <div class="stat-sub">(16 / 157)</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="progress-ring-container">
                        <div class="progress-ring">
                            <svg width="80" height="80">
                                <circle class="progress-bg" cx="40" cy="40" r="32"></circle>
                                <circle class="progress-fill" cx="40" cy="40" r="32" stroke="#FF9800" stroke-dasharray="201" stroke-dashoffset="201"></circle>
                            </svg>
                            <span class="progress-text" style="color: #FF9800;">0%</span>
                        </div>
                        <div class="stat-label" data-tr="Satış / Cevaplanan" data-de="Verkauf / Antwortete">Satış / Cevaplanan</div>
                        <div class="stat-sub">(0 / 16)</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="progress-ring-container">
                        <div class="progress-ring">
                            <svg width="80" height="80">
                                <circle class="progress-bg" cx="40" cy="40" r="32"></circle>
                                <circle class="progress-fill" cx="40" cy="40" r="32" stroke="#2196F3" stroke-dasharray="201" stroke-dashoffset="175"></circle>
                            </svg>
                            <span class="progress-text" style="color: #2196F3;">13%</span>
                        </div>
                        <div class="stat-label" data-tr="Geri Arama / Cevaplanan" data-de="Wiedervorlage / Antwortete">Geri Arama / Cevaplanan</div>
                        <div class="stat-sub">(2 / 16)</div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div class="stat-card" style="border-radius: 12px; text-align: left;">
                    <h5 style="margin: 0 0 1rem 0; color: #9e9e9e; font-size: 0.9rem;">
                        <i class="ti ti-phone"></i> <span data-tr="Arama Detayları" data-de="Anrufdetails">Arama Detayları</span>
                    </h5>
                    <table style="width: 100%; font-size: 0.9rem; color: #e0e0e0;">
                        <tr><td data-tr="Toplam Numara" data-de="Gesamte Nummern">Toplam Numara</td><td style="text-align: right; font-weight: 600;">421</td></tr>
                        <tr><td data-tr="Giden/Gelen Çağrılar" data-de="Eingehende/ausgehende Anrufe">Giden/Gelen Çağrılar</td><td style="text-align: right; font-weight: 600;">157</td></tr>
                        <tr><td data-tr="Aranacak Numara" data-de="Zu rufende Nummern">Aranacak Numara</td><td style="text-align: right; font-weight: 600; color: #4CAF50;">252</td></tr>
                        <tr><td>Drop</td><td style="text-align: right; font-weight: 600; color: #f44336;">10</td></tr>
                    </table>
                </div>
                <div class="stat-card" style="border-radius: 12px; text-align: left;">
                    <h5 style="margin: 0 0 1rem 0; color: #9e9e9e; font-size: 0.9rem;">
                        <i class="ti ti-chart-bar"></i> <span data-tr="Arama İstatistikleri" data-de="Anrufstatistik">Arama İstatistikleri</span>
                    </h5>
                    <table style="width: 100%; font-size: 0.9rem; color: #e0e0e0;">
                        <tr><td data-tr="Cevaplanan" data-de="Antwortete">Cevaplanan</td><td style="text-align: right; font-weight: 600; color: #4CAF50;">16</td></tr>
                        <tr><td data-tr="Ulaşılamadı" data-de="Nicht Erreicht">Ulaşılamadı</td><td style="text-align: right; font-weight: 600;">68</td></tr>
                        <tr><td data-tr="Telesekreter" data-de="Anrufbeantworter">Telesekreter</td><td style="text-align: right; font-weight: 600;">55</td></tr>
                        <tr><td data-tr="Bağlantı Hatası" data-de="Verbindungsfehler">Bağlantı Hatası</td><td style="text-align: right; font-weight: 600; color: #f44336;">18</td></tr>
                    </table>
                </div>
                <div class="stat-card" style="border-radius: 12px; text-align: left;">
                    <h5 style="margin: 0 0 1rem 0; color: #9e9e9e; font-size: 0.9rem;">
                        <i class="ti ti-clock"></i> <span data-tr="Süre Bilgileri" data-de="Gesamtdauer">Süre Bilgileri</span>
                    </h5>
                    <table style="width: 100%; font-size: 0.9rem; color: #e0e0e0;">
                        <tr><td data-tr="Toplam Arama Süresi" data-de="Gesamte Anrufszeit">Toplam Arama Süresi</td><td style="text-align: right; font-weight: 600; color: #2196F3;">00:23:51</td></tr>
                        <tr><td data-tr="Ortalama Süre" data-de="Durchschnitt Anrufszeit">Ortalama Süre</td><td style="text-align: right; font-weight: 600;">00:01:29</td></tr>
                        <tr><td data-tr="Son Arama" data-de="Letzter Anruf">Son Arama</td><td style="text-align: right; font-weight: 600; color: #FF9800;">02.01.2026</td></tr>
                        <tr><td data-tr="Başlangıç" data-de="Datum">Başlangıç</td><td style="text-align: right; font-weight: 600;">29.12.2025</td></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Statistics Modal -->
<div class="modal-overlay" id="processModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="ti ti-list-check"></i> <span data-tr="Prosesler" data-de="Prozesse">Prosesler</span>: <span id="processDataName">-</span></h3>
            <button class="modal-close" onclick="closeModal('processModal')"><i class="ti ti-x"></i></button>
        </div>
        <div class="modal-body">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; background: #252536; padding: 1rem; border-radius: 10px;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label style="color: #9e9e9e; display: block; margin-bottom: 0.5rem;" data-tr="Başlangıç Tarihi" data-de="Anfangsdatum">Başlangıç Tarihi</label>
                    <input type="date" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: #1a1a2e; color: #fff;">
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label style="color: #9e9e9e; display: block; margin-bottom: 0.5rem;" data-tr="Bitiş Tarihi" data-de="Enddatum">Bitiş Tarihi</label>
                    <input type="date" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: #1a1a2e; color: #fff;">
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label style="color: #9e9e9e; display: block; margin-bottom: 0.5rem;" data-tr="Proses Türü" data-de="Prozessart">Proses Türü</label>
                    <select style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: #1a1a2e; color: #fff;">
                        <option>Default</option>
                    </select>
                </div>
            </div>
            
            <table class="disposition-table">
                <thead>
                    <tr>
                        <th data-tr="Durum Adı" data-de="Name">Durum Adı</th>
                        <th data-tr="Adet" data-de="Anzahl">Adet</th>
                        <th data-tr="Yüzde" data-de="Prozent">Yüzde</th>
                        <th>Revert</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #4CAF50;"></span> <span data-tr="Yeni Veri (aranabilir)" data-de="Neue Daten (kann größer als Null sein.)">Yeni Veri (aranabilir)</span></span></td>
                        <td class="count-cell">22</td>
                        <td class="percent-cell">1.7%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #2196F3;"></span> <span data-tr="Kuyrukta Bekliyor" data-de="Daten in der Schlange">Kuyrukta Bekliyor</span></span></td>
                        <td class="count-cell">1150</td>
                        <td class="percent-cell">88.4%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #FF9800;"></span> <span data-tr="Cevap Yok" data-de="Kein Antwort">Cevap Yok</span></span></td>
                        <td class="count-cell">51</td>
                        <td class="percent-cell">3.8%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #f44336;"></span> Drop</span></td>
                        <td class="count-cell">2</td>
                        <td class="percent-cell">0.2%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #9C27B0;"></span> <span data-tr="Meşgul" data-de="Besetzt">Meşgul</span></span></td>
                        <td class="count-cell">21</td>
                        <td class="percent-cell">1.6%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #607D8B;"></span> <span data-tr="Devre Dışı" data-de="Ausser Betrieb">Devre Dışı</span></span></td>
                        <td class="count-cell">29</td>
                        <td class="percent-cell">2.2%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr>
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #795548;"></span> <span data-tr="Telesekreter" data-de="System Anrufbeantworter">Telesekreter</span></span></td>
                        <td class="count-cell">47</td>
                        <td class="percent-cell">3.5%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr style="background: rgba(76, 175, 80, 0.1);">
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #4CAF50;"></span> <strong style="color: #4CAF50;">VERKAUF OK</strong></span></td>
                        <td class="count-cell" style="color: #4CAF50;">1</td>
                        <td class="percent-cell">0.1%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                    <tr style="background: rgba(244, 67, 54, 0.1);">
                        <td><span class="dispo-name"><span class="dispo-dot" style="background: #f44336;"></span> <span data-tr="İlgilenmiyor" data-de="Kein Interesse">İlgilenmiyor</span></span></td>
                        <td class="count-cell" style="color: #f44336;">2</td>
                        <td class="percent-cell">0.2%</td>
                        <td>0</td>
                        <td><button class="action-btn info"><i class="ti ti-refresh"></i></button> <button class="action-btn success"><i class="ti ti-download"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// File handling
let selectedFile = null;
let analysisData = null;

// Toggle upload panel
function toggleUploadPanel() {
    const panel = document.getElementById('uploadPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// File selection
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('selectedFile').classList.add('show');
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeFile() {
    selectedFile = null;
    analysisData = null;
    document.getElementById('selectedFile').classList.remove('show');
    document.getElementById('fileInput').value = '';
    document.getElementById('analysisResults').classList.remove('show');
}

// Drag and drop
const dropZone = document.getElementById('dropZone');
if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#4CAF50';
        dropZone.style.background = 'rgba(76, 175, 80, 0.1)';
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = 'rgba(255,255,255,0.3)';
        dropZone.style.background = 'transparent';
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'rgba(255,255,255,0.3)';
        dropZone.style.background = 'transparent';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('fileInput').files = files;
            handleFileSelect({ target: { files: files } });
        }
    });
}

// Analyze file
function analyzeFile() {
    const dataName = document.getElementById('dataName').value.trim();
    
    if (!dataName) {
        alert(document.documentElement.lang === 'de' ? 'Bitte geben Sie einen Datennamen ein' : 'Lütfen veri adı girin');
        document.getElementById('dataName').focus();
        return;
    }
    
    if (!selectedFile) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie zuerst eine Datei aus' : 'Lütfen önce bir dosya seçin');
        return;
    }
    
    const btn = document.getElementById('analyzeBtn');
    btn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> <span>' + (document.documentElement.lang === 'de' ? 'Wird analysiert...' : 'Analiz ediliyor...') + '</span>';
    btn.disabled = true;
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('name', dataName);
    formData.append('campaign_id', document.getElementById('campaignSelect').value);
    formData.append('duplicate_check', document.getElementById('duplicateCheck').value);
    formData.append('priority', document.getElementById('prioritySelect').value);
    
    fetch('/api/data/analyze', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Server'dan gelen data'ya name ekle
        data.name = dataName;
        analysisData = data;
        showAnalysisResults(data);
    })
    .catch(error => {
        // Demo mode
        analysisData = {
            name: dataName,
            total: Math.floor(Math.random() * 1000) + 500,
            valid: 0,
            errors: Math.floor(Math.random() * 30),
            duplicates: Math.floor(Math.random() * 20),
            blacklist: Math.floor(Math.random() * 10),
            with_iban: 0,
            file_id: 'demo_' + Date.now()
        };
        analysisData.valid = analysisData.total - analysisData.errors;
        analysisData.with_iban = Math.floor(analysisData.valid * 0.65);
        showAnalysisResults(analysisData);
    })
    .finally(() => {
        btn.innerHTML = '<i class="ti ti-search"></i> <span>' + (document.documentElement.lang === 'de' ? 'Datei analysieren' : 'Dosyayı Analiz Et') + '</span>';
        btn.disabled = false;
    });
}

function showAnalysisResults(data) {
    document.getElementById('statTotal').textContent = data.total.toLocaleString();
    document.getElementById('statValid').textContent = data.valid.toLocaleString();
    document.getElementById('statDuplicate').textContent = data.duplicates.toString();
    document.getElementById('statBlacklist').textContent = data.blacklist.toString();
    document.getElementById('statIban').textContent = (data.with_iban || 0).toLocaleString();
    document.getElementById('statError').textContent = data.errors.toString();
    
    document.getElementById('analysisResults').classList.add('show');
    document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
}

// Confirm import
function confirmImport() {
    if (!analysisData) return;
    
    const dataName = analysisData.name || document.getElementById('dataName').value.trim();
    
    if (!dataName) {
        alert('Veri adı gerekli!');
        return;
    }
    
    const btn = event.currentTarget;
    btn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> <span>' + (document.documentElement.lang === 'de' ? 'Wird gespeichert...' : 'Kaydediliyor...') + '</span>';
    btn.disabled = true;
    
    const requestData = {
        file_id: analysisData.file_id,
        name: dataName,
        campaign_id: document.getElementById('campaignSelect').value,
        total: analysisData.total,
        valid: analysisData.valid,
        duplicates: analysisData.duplicates || 0,
        blacklist: analysisData.blacklist || 0,
        errors: analysisData.errors || 0
    };
    
    console.log('Sending confirm request:', requestData);
    
    fetch('/api/data/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        console.log('Confirm response:', data);
        if (data.error) {
            alert('Hata: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-check"></i> <span>' + (document.documentElement.lang === 'de' ? 'Bestätigen und speichern' : 'Onayla ve Kaydet') + '</span>';
            return;
        }
        alert(document.documentElement.lang === 'de' 
            ? `✅ Erfolgreich! "${dataName}" wurde gespeichert. ${data.added || analysisData.valid} Datensätze importiert.` 
            : `✅ Başarılı! "${dataName}" kaydedildi. ${data.added || analysisData.valid} kayıt aktarıldı.`);
        location.reload();
    })
    .catch(error => {
        console.error('Confirm error:', error);
        alert('Kayıt hatası: ' + (error.error || error.message || 'Bilinmeyen hata'));
        btn.disabled = false;
        btn.innerHTML = '<i class="ti ti-check"></i> <span>' + (document.documentElement.lang === 'de' ? 'Bestätigen und speichern' : 'Onayla ve Kaydet') + '</span>';
    });
}

function addToDataTable(data) {
    const tbody = document.getElementById('activeDataBody');
    const newId = Math.floor(Math.random() * 100) + 400;
    const now = new Date();
    
    const row = document.createElement('tr');
    row.dataset.id = newId;
    row.innerHTML = `
        <td><input type="checkbox" class="row-checkbox" value="${newId}"></td>
        <td class="id-cell">${newId}</td>
        <td class="name-cell" onclick="showDataStats(${newId}, '${data.name}')">${data.name}</td>
        <td><span class="campaign-badge"><i class="ti ti-speakerphone"></i> 100000 - Beelife2</span></td>
        <td><span class="stat-new">${data.valid}</span>/<span class="stat-total">${data.total}</span></td>
        <td class="stat-calling">0</td>
        <td class="stat-sales">0</td>
        <td class="date-cell"><div class="date">${now.toLocaleDateString('de-DE')}</div><div class="time">${now.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</div></td>
        <td><label class="status-toggle"><input type="checkbox" checked onchange="toggleStatus(${newId}, this.checked)"><span class="status-slider"></span></label></td>
        <td><div class="action-btns"><button class="action-btn info" onclick="showDataStats(${newId}, '${data.name}')"><i class="ti ti-chart-pie"></i></button><button class="action-btn" onclick="showDataProcesses(${newId})"><i class="ti ti-list-check"></i></button><button class="action-btn success"><i class="ti ti-download"></i></button></div></td>
    `;
    tbody.insertBefore(row, tbody.firstChild);
    
    // Update count
    const countEl = document.getElementById('activeCount');
    countEl.textContent = parseInt(countEl.textContent) + 1;
    document.getElementById('totalRecords').textContent = parseInt(document.getElementById('totalRecords').textContent) + 1;
}

// Cancel import
function cancelImport() {
    if (confirm(document.documentElement.lang === 'de' ? 'Import abbrechen?' : 'İçe aktarmayı iptal et?')) {
        if (analysisData && analysisData.file_id) {
            fetch('/api/data/cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_id: analysisData.file_id })
            }).catch(() => {});
        }
        resetUpload();
    }
}

function resetUpload() {
    selectedFile = null;
    analysisData = null;
    document.getElementById('selectedFile').classList.remove('show');
    document.getElementById('fileInput').value = '';
    document.getElementById('dataName').value = '';
    document.getElementById('analysisResults').classList.remove('show');
}

// Tab switching
function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    
    event.currentTarget.classList.add('active');
    document.getElementById(tab + 'Tab').style.display = 'block';
}

// Toggle row selection
function toggleAllRows(checkbox) {
    const rows = document.querySelectorAll('.data-table tbody .row-checkbox');
    rows.forEach(row => {
        row.checked = checkbox.checked;
        row.closest('tr').classList.toggle('selected', checkbox.checked);
    });
}

// Toggle status
function toggleStatus(id, active) {
    console.log('Toggle status:', id, active);
    
    if (!active) {
        // Move to inactive
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
            const inactiveBody = document.getElementById('inactiveDataBody');
            const emptyRow = inactiveBody.querySelector('td[colspan]');
            if (emptyRow) emptyRow.parentElement.remove();
            
            const newRow = row.cloneNode(true);
            newRow.querySelector('.status-toggle').remove();
            
            // Add reactivate button
            const actionTd = document.createElement('td');
            actionTd.innerHTML = `
                <div class="action-btns">
                    <button class="action-btn success" title="Aktifleştir" onclick="reactivateData(${id})">
                        <i class="ti ti-player-play"></i>
                    </button>
                    <button class="action-btn danger" title="Sil">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            `;
            newRow.querySelector('.action-btns').parentElement.replaceWith(actionTd);
            
            inactiveBody.appendChild(newRow);
            row.remove();
            
            // Update counts
            updateCounts();
        }
    }
}

function reactivateData(id) {
    const row = document.querySelector(`#inactiveDataBody tr[data-id="${id}"]`);
    if (row) {
        // Reload page to refresh properly
        location.reload();
    }
}

function updateCounts() {
    const activeCount = document.querySelectorAll('#activeDataBody tr[data-id]').length;
    const inactiveCount = document.querySelectorAll('#inactiveDataBody tr[data-id]').length;
    
    document.getElementById('activeCount').textContent = activeCount;
    document.getElementById('inactiveCount').textContent = inactiveCount;
    document.getElementById('totalRecords').textContent = activeCount;
}

// Modal functions
function showDataStats(id, name) {
    document.getElementById('statsDataName').textContent = name;
    document.getElementById('statsModal').classList.add('active');
}

function showDataProcesses(id) {
    document.getElementById('processDataName').textContent = document.querySelector(`tr[data-id="${id}"] .name-cell`).textContent;
    document.getElementById('processModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// Close modal on outside click
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});

// Toolbar functions
function editSelected() {
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir satır seçin');
        return;
    }
    alert('Düzenleme modu...');
}

function deleteSelected() {
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir satır seçin');
        return;
    }
    if (confirm(document.documentElement.lang === 'de' ? `${selected.length} Einträge löschen?` : `${selected.length} kayıt silinsin mi?`)) {
        // Send delete request to server
        selected.forEach(cb => {
            const id = cb.value;
            fetch(`/api/data/delete/${id}`, { method: 'DELETE' }).catch(() => {});
            cb.closest('tr').remove();
        });
        updateCounts();
    }
}

function downloadSelected() {
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir satır seçin');
        return;
    }
    alert(document.documentElement.lang === 'de' 
        ? `${selected.length} Datensätze werden heruntergeladen...` 
        : `${selected.length} veri indiriliyor...`);
}

function showProcesses() {
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length > 0) {
        const firstName = document.querySelector('.data-table tbody .row-checkbox:checked').closest('tr').querySelector('.name-cell').textContent;
        document.getElementById('processDataName').textContent = firstName + (selected.length > 1 ? ` (+${selected.length - 1})` : '');
    }
    document.getElementById('processModal').classList.add('active');
}

// Options Dropdown Menu
function toggleOptionsMenu() {
    const menu = document.getElementById('optionsMenu');
    menu.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.dropdown-wrapper');
    const menu = document.getElementById('optionsMenu');
    if (dropdown && !dropdown.contains(e.target)) {
        menu.classList.remove('show');
    }
});

// Batch functions
function batchDataStats() {
    document.getElementById('optionsMenu').classList.remove('show');
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir veri seçin');
        return;
    }
    const firstName = selected[0].closest('tr').querySelector('.name-cell').textContent;
    document.getElementById('statsDataName').textContent = firstName + (selected.length > 1 ? ` (+${selected.length - 1})` : '');
    document.getElementById('statsModal').classList.add('active');
}

function batchProcess() {
    document.getElementById('optionsMenu').classList.remove('show');
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir veri seçin');
        return;
    }
    const msg = document.documentElement.lang === 'de'
        ? `${selected.length} Datensätze werden verarbeitet...`
        : `${selected.length} veri toplu işleme alınıyor...`;
    alert(msg);
    // TODO: Backend API call for batch processing
}

function showTransactionPlan() {
    document.getElementById('optionsMenu').classList.remove('show');
    alert(document.documentElement.lang === 'de' ? 'Transaktionsplan wird geöffnet...' : 'İşlem planı açılıyor...');
}

function batchStatusUpdate() {
    document.getElementById('optionsMenu').classList.remove('show');
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir veri seçin');
        return;
    }
    if (confirm(document.documentElement.lang === 'de' 
        ? `${selected.length} Datensätze aktualisieren?` 
        : `${selected.length} verinin durumu güncellensin mi?`)) {
        alert(document.documentElement.lang === 'de' ? 'Status wird aktualisiert...' : 'Durum güncelleniyor...');
    }
}

function copySelectedData() {
    document.getElementById('optionsMenu').classList.remove('show');
    const selected = document.querySelectorAll('.data-table tbody .row-checkbox:checked');
    if (selected.length === 0) {
        alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zeile aus' : 'Lütfen en az bir veri seçin');
        return;
    }
    alert(document.documentElement.lang === 'de' 
        ? `${selected.length} Datensätze werden kopiert...` 
        : `${selected.length} veri kopyalanıyor...`);
}

function resetQueue() {
    document.getElementById('optionsMenu').classList.remove('show');
    if (confirm(document.documentElement.lang === 'de' 
        ? 'Warteschlange zurücksetzen? Alle laufenden Anrufe werden gestoppt.' 
        : 'Kuyruk sıfırlansın mı? Tüm devam eden aramalar durdurulacak.')) {
        alert(document.documentElement.lang === 'de' ? 'Warteschlange wird zurückgesetzt...' : 'Kuyruk sıfırlanıyor...');
    }
}

function refreshData() {
    location.reload();
}
</script>
{% endblock %}
