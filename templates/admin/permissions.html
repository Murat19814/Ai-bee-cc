{% extends "base.html" %}

{% block title %}Yetki Yönetimi - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.perm-container {
    padding: 1.5rem;
}

/* Header */
.perm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.perm-header h1 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.75rem;
    font-weight: 800;
}

.perm-header h1 i {
    color: var(--primary);
}

/* Tabs */
.perm-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0;
}

.perm-tab {
    padding: 1rem 1.5rem;
    background: transparent;
    border: none;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}

.perm-tab:hover {
    color: var(--primary);
}

.perm-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

/* Tab Content */
.perm-tab-content {
    display: none;
}

.perm-tab-content.active {
    display: block;
}

/* Role Cards */
.role-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
}

.role-card {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all 0.3s;
}

.role-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.role-card-header {
    padding: 1.5rem;
    color: white;
    position: relative;
}

.role-card-header.super_admin { background: linear-gradient(135deg, #dc2626, #b91c1c); }
.role-card-header.admin { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
.role-card-header.supervisor { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
.role-card-header.qc_listener { background: linear-gradient(135deg, #10b981, #059669); }
.role-card-header.agent { background: linear-gradient(135deg, #f59e0b, #d97706); }
.role-card-header.analyst { background: linear-gradient(135deg, #6366f1, #4f46e5); }

.role-icon {
    width: 56px;
    height: 56px;
    background: rgba(255,255,255,0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    margin-bottom: 1rem;
}

.role-name {
    font-size: 1.25rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
}

.role-description {
    font-size: 0.9rem;
    opacity: 0.9;
}

.role-card-body {
    padding: 1.5rem;
}

.role-perm-count {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.role-perm-count i {
    color: var(--primary);
}

.role-actions {
    display: flex;
    gap: 0.5rem;
}

.role-btn {
    flex: 1;
    padding: 0.75rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.role-btn.primary {
    background: var(--primary);
    color: white;
}

.role-btn.secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.role-btn:hover {
    transform: translateY(-2px);
}

/* Permission Modules */
.perm-modules {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.perm-module {
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.perm-module-header {
    padding: 1rem 1.5rem;
    background: var(--bg-secondary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
}

.perm-module-header:hover {
    background: var(--border-color);
}

.perm-module-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 700;
}

.perm-module-title i {
    font-size: 1.25rem;
    color: var(--primary);
}

.perm-module-toggle {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.perm-module-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.perm-module-body {
    padding: 1.5rem;
    display: none;
}

.perm-module.open .perm-module-body {
    display: block;
}

.perm-module.open .perm-module-header i.ti-chevron-down {
    transform: rotate(180deg);
}

/* Permission Grid */
.perm-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.perm-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    background: var(--bg-secondary);
    transition: all 0.2s;
}

.perm-item:hover {
    background: var(--border-color);
}

.perm-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid var(--border-color);
    cursor: pointer;
    accent-color: var(--primary);
}

.perm-info {
    flex: 1;
}

.perm-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.perm-code {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-family: monospace;
}

/* User Permissions */
.user-perm-panel {
    background: var(--card-bg);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.user-perm-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
}

.user-perm-body {
    padding: 1.5rem;
}

.user-select-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.user-select-group {
    flex: 1;
}

.user-select-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.user-select-group select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.quick-action-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quick-action-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.quick-action-btn.danger:hover {
    border-color: #dc2626;
    color: #dc2626;
}

/* Comparison Table */
.comparison-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.comparison-table th,
.comparison-table td {
    padding: 0.75rem;
    text-align: center;
    border: 1px solid var(--border-color);
}

.comparison-table th {
    background: var(--bg-secondary);
    font-weight: 700;
}

.comparison-table th:first-child,
.comparison-table td:first-child {
    text-align: left;
    font-weight: 600;
}

.comparison-table .has-perm {
    color: #10b981;
}

.comparison-table .no-perm {
    color: #ef4444;
}

/* Modal */
.perm-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.perm-modal.active {
    display: flex;
}

.perm-modal-content {
    background: var(--card-bg);
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.perm-modal-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.perm-modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
}

.perm-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.modal-close {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

@media (max-width: 768px) {
    .role-grid {
        grid-template-columns: 1fr;
    }
    
    .perm-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="perm-container">
    <!-- Header -->
    <div class="perm-header">
        <div>
            <h1>
                <i class="ti ti-shield-lock"></i>
                <span data-tr="Yetki Yönetimi" data-de="Berechtigungsverwaltung">Yetki Yönetimi</span>
            </h1>
            <p class="text-muted" data-tr="Rol şablonları ve kullanıcı yetkileri" data-de="Rollenvorlagen und Benutzerberechtigungen">Rol şablonları ve kullanıcı yetkileri</p>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="perm-tabs">
        <button class="perm-tab active" data-tab="roles" onclick="switchTab('roles')">
            <i class="ti ti-users-group"></i>
            <span data-tr="Rol Şablonları" data-de="Rollenvorlagen">Rol Şablonları</span>
        </button>
        <button class="perm-tab" data-tab="permissions" onclick="switchTab('permissions')">
            <i class="ti ti-key"></i>
            <span data-tr="Tüm Yetkiler" data-de="Alle Berechtigungen">Tüm Yetkiler</span>
        </button>
        <button class="perm-tab" data-tab="users" onclick="switchTab('users')">
            <i class="ti ti-user-cog"></i>
            <span data-tr="Kullanıcı Yetkileri" data-de="Benutzerberechtigungen">Kullanıcı Yetkileri</span>
        </button>
        <button class="perm-tab" data-tab="comparison" onclick="switchTab('comparison')">
            <i class="ti ti-table"></i>
            <span data-tr="Karşılaştırma" data-de="Vergleich">Karşılaştırma</span>
        </button>
    </div>
    
    <!-- Tab: Rol Şablonları -->
    <div class="perm-tab-content active" id="tab-roles">
        <div class="role-grid">
            {% for role_code, role in ROLE_TEMPLATES.items() %}
            <div class="role-card">
                <div class="role-card-header {{ role_code }}">
                    <div class="role-icon">
                        <i class="{{ role.icon }}"></i>
                    </div>
                    <div class="role-name">{{ role.name }}</div>
                    <div class="role-description">{{ role.description }}</div>
                </div>
                <div class="role-card-body">
                    <div class="role-perm-count">
                        <i class="ti ti-key"></i>
                        {% if role.permissions == '*' %}
                        <span data-tr="Tüm Yetkiler" data-de="Alle Berechtigungen">Tüm Yetkiler</span>
                        {% else %}
                        <span>{{ role.permissions|length }} <span data-tr="Yetki" data-de="Berechtigungen">Yetki</span></span>
                        {% endif %}
                    </div>
                    <div class="role-actions">
                        <button class="role-btn primary" onclick="viewRolePermissions('{{ role_code }}')">
                            <i class="ti ti-eye"></i>
                            <span data-tr="Detay" data-de="Details">Detay</span>
                        </button>
                        <button class="role-btn secondary" onclick="applyRoleToUser('{{ role_code }}')">
                            <i class="ti ti-user-plus"></i>
                            <span data-tr="Uygula" data-de="Anwenden">Uygula</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Tab: Tüm Yetkiler -->
    <div class="perm-tab-content" id="tab-permissions">
        <div class="perm-modules">
            {% for module_code, module in PERMISSIONS.items() %}
            <div class="perm-module" id="module-{{ module_code }}">
                <div class="perm-module-header" onclick="toggleModule('{{ module_code }}')">
                    <div class="perm-module-title">
                        <i class="ti ti-{% if module_code == 'dashboard' %}dashboard{% elif module_code == 'crm' %}users{% elif module_code == 'calls' %}phone{% elif module_code == 'recordings' %}microphone{% elif module_code == 'qc' %}headphones{% elif module_code == 'campaigns' %}speakerphone{% elif module_code == 'projects' %}folders{% elif module_code == 'reports' %}chart-bar{% elif module_code == 'users' %}user-cog{% elif module_code == 'roles' %}shield{% elif module_code == 'voip' %}phone-call{% elif module_code == 'blacklist' %}ban{% elif module_code == 'ai' %}robot{% elif module_code == 'settings' %}settings{% elif module_code == 'notifications' %}bell{% elif module_code == 'platform' %}server{% else %}key{% endif %}"></i>
                        <span>{{ module.name }}</span>
                    </div>
                    <div class="perm-module-toggle">
                        <span class="perm-module-count">{{ module.permissions|length }} yetki</span>
                        <i class="ti ti-chevron-down"></i>
                    </div>
                </div>
                <div class="perm-module-body">
                    <div class="perm-grid">
                        {% for perm_code, perm in module.permissions.items() %}
                        <div class="perm-item">
                            <input type="checkbox" class="perm-checkbox" id="perm-{{ perm_code }}" disabled checked>
                            <div class="perm-info">
                                <div class="perm-name">{{ perm.name }}</div>
                                <div class="perm-code">{{ perm_code }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Tab: Kullanıcı Yetkileri -->
    <div class="perm-tab-content" id="tab-users">
        <div class="user-perm-panel">
            <div class="user-perm-header">
                <h3><i class="ti ti-user-cog"></i> Kullanıcı Yetki Yönetimi</h3>
                <p>Kullanıcı seçin ve yetkilerini düzenleyin</p>
            </div>
            <div class="user-perm-body">
                <div class="user-select-row">
                    <div class="user-select-group">
                        <label data-tr="Kullanıcı Seç" data-de="Benutzer auswählen">Kullanıcı Seç</label>
                        <select id="userSelect" onchange="loadUserPermissions()">
                            <option value="">-- Kullanıcı Seçin --</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }} ({{ user.role }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="user-select-group">
                        <label data-tr="Rol Şablonu Uygula" data-de="Rollenvorlage anwenden">Rol Şablonu Uygula</label>
                        <select id="roleTemplateSelect" onchange="applyRoleTemplate()">
                            <option value="">-- Şablon Seçin --</option>
                            {% for role_code, role in ROLE_TEMPLATES.items() %}
                            <option value="{{ role_code }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="selectAllPermissions()">
                        <i class="ti ti-check"></i> Tümünü Seç
                    </button>
                    <button class="quick-action-btn danger" onclick="clearAllPermissions()">
                        <i class="ti ti-x"></i> Tümünü Kaldır
                    </button>
                    <button class="quick-action-btn" onclick="saveUserPermissions()">
                        <i class="ti ti-device-floppy"></i> Kaydet
                    </button>
                </div>
                
                <div id="userPermissionsContainer">
                    <p class="text-muted text-center" style="padding: 2rem;">
                        <i class="ti ti-user-search" style="font-size: 3rem; opacity: 0.3;"></i><br>
                        Yetkileri düzenlemek için bir kullanıcı seçin
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab: Karşılaştırma -->
    <div class="perm-tab-content" id="tab-comparison">
        <div class="card">
            <div class="card-header">
                <h3><i class="ti ti-table"></i> Rol Yetki Karşılaştırması</h3>
            </div>
            <div class="card-body" style="overflow-x: auto;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Modül / Yetki</th>
                            {% for role_code, role in ROLE_TEMPLATES.items() %}
                            <th>{{ role.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for module_code, module in PERMISSIONS.items() %}
                        <tr style="background: var(--bg-secondary);">
                            <td colspan="{{ ROLE_TEMPLATES|length + 1 }}"><strong>{{ module.name }}</strong></td>
                        </tr>
                        {% for perm_code, perm in module.permissions.items() %}
                        <tr>
                            <td>{{ perm.name }}</td>
                            {% for role_code, role in ROLE_TEMPLATES.items() %}
                            <td>
                                {% if role.permissions == '*' or perm_code in role.permissions %}
                                <i class="ti ti-check has-perm"></i>
                                {% else %}
                                <i class="ti ti-x no-perm"></i>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Rol Detay -->
<div class="perm-modal" id="roleDetailModal">
    <div class="perm-modal-content">
        <div class="perm-modal-header">
            <h3 id="roleDetailTitle">Rol Detayları</h3>
            <button class="modal-close" onclick="closeModal('roleDetailModal')">&times;</button>
        </div>
        <div class="perm-modal-body" id="roleDetailBody">
            <!-- Dynamic content -->
        </div>
        <div class="perm-modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('roleDetailModal')">Kapat</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const PERMISSIONS = {{ PERMISSIONS|tojson|safe }};
const ROLE_TEMPLATES = {{ ROLE_TEMPLATES|tojson|safe }};

function switchTab(tabId) {
    document.querySelectorAll('.perm-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.perm-tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    document.getElementById(`tab-${tabId}`).classList.add('active');
}

function toggleModule(moduleCode) {
    document.getElementById(`module-${moduleCode}`).classList.toggle('open');
}

function viewRolePermissions(roleCode) {
    const role = ROLE_TEMPLATES[roleCode];
    if (!role) return;
    
    document.getElementById('roleDetailTitle').textContent = role.name + ' - Yetkiler';
    
    let html = '<div class="perm-modules">';
    
    for (const [modCode, module] of Object.entries(PERMISSIONS)) {
        const modulePerms = Object.entries(module.permissions).filter(([code, p]) => {
            return role.permissions === '*' || role.permissions.includes(code);
        });
        
        if (modulePerms.length === 0) continue;
        
        html += `
            <div class="perm-module open">
                <div class="perm-module-header">
                    <div class="perm-module-title">
                        <i class="ti ti-key"></i>
                        <span>${module.name}</span>
                    </div>
                    <span class="perm-module-count">${modulePerms.length} yetki</span>
                </div>
                <div class="perm-module-body">
                    <div class="perm-grid">
        `;
        
        modulePerms.forEach(([code, perm]) => {
            html += `
                <div class="perm-item">
                    <i class="ti ti-check" style="color: #10b981;"></i>
                    <div class="perm-info">
                        <div class="perm-name">${perm.name}</div>
                        <div class="perm-code">${code}</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div></div></div>';
    }
    
    html += '</div>';
    
    document.getElementById('roleDetailBody').innerHTML = html;
    document.getElementById('roleDetailModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function applyRoleToUser(roleCode) {
    switchTab('users');
    document.getElementById('roleTemplateSelect').value = roleCode;
}

async function loadUserPermissions() {
    const userId = document.getElementById('userSelect').value;
    if (!userId) {
        document.getElementById('userPermissionsContainer').innerHTML = `
            <p class="text-muted text-center" style="padding: 2rem;">
                <i class="ti ti-user-search" style="font-size: 3rem; opacity: 0.3;"></i><br>
                Yetkileri düzenlemek için bir kullanıcı seçin
            </p>
        `;
        return;
    }
    
    try {
        const res = await fetch(`/api/admin/user/${userId}/permissions`);
        const data = await res.json();
        
        if (!data.success) {
            alert(data.error || 'Hata oluştu');
            return;
        }
        
        renderUserPermissions(data.permissions, data.role);
    } catch (e) {
        console.error(e);
        alert('Yetkiler yüklenemedi');
    }
}

function renderUserPermissions(userPerms, userRole) {
    let html = `
        <div class="alert alert-info" style="margin-bottom: 1rem;">
            <i class="ti ti-info-circle"></i>
            Mevcut rol: <strong>${userRole}</strong> - Rol yetkilerine ek olarak özel yetkiler atayabilirsiniz.
        </div>
        <div class="perm-modules">
    `;
    
    for (const [modCode, module] of Object.entries(PERMISSIONS)) {
        html += `
            <div class="perm-module open">
                <div class="perm-module-header" onclick="toggleModule('user-${modCode}')">
                    <div class="perm-module-title">
                        <i class="ti ti-key"></i>
                        <span>${module.name}</span>
                    </div>
                </div>
                <div class="perm-module-body" id="module-user-${modCode}">
                    <div class="perm-grid">
        `;
        
        for (const [code, perm] of Object.entries(module.permissions)) {
            const checked = userPerms.includes(code) ? 'checked' : '';
            html += `
                <div class="perm-item">
                    <input type="checkbox" class="perm-checkbox user-perm-check" 
                           data-perm="${code}" ${checked}>
                    <div class="perm-info">
                        <div class="perm-name">${perm.name}</div>
                        <div class="perm-code">${code}</div>
                    </div>
                </div>
            `;
        }
        
        html += '</div></div></div>';
    }
    
    html += '</div>';
    document.getElementById('userPermissionsContainer').innerHTML = html;
}

function applyRoleTemplate() {
    const roleCode = document.getElementById('roleTemplateSelect').value;
    if (!roleCode) return;
    
    const role = ROLE_TEMPLATES[roleCode];
    if (!role) return;
    
    document.querySelectorAll('.user-perm-check').forEach(cb => {
        if (role.permissions === '*') {
            cb.checked = true;
        } else {
            cb.checked = role.permissions.includes(cb.dataset.perm);
        }
    });
}

function selectAllPermissions() {
    document.querySelectorAll('.user-perm-check').forEach(cb => cb.checked = true);
}

function clearAllPermissions() {
    document.querySelectorAll('.user-perm-check').forEach(cb => cb.checked = false);
}

async function saveUserPermissions() {
    const userId = document.getElementById('userSelect').value;
    if (!userId) {
        alert('Lütfen bir kullanıcı seçin');
        return;
    }
    
    const permissions = [];
    document.querySelectorAll('.user-perm-check:checked').forEach(cb => {
        permissions.push(cb.dataset.perm);
    });
    
    try {
        const res = await fetch(`/api/admin/user/${userId}/permissions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ permissions })
        });
        
        const data = await res.json();
        if (data.success) {
            alert('Yetkiler kaydedildi!');
        } else {
            alert(data.error || 'Hata oluştu');
        }
    } catch (e) {
        console.error(e);
        alert('Kaydetme hatası');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Expand first module by default
    document.querySelector('.perm-module')?.classList.add('open');
});
</script>
{% endblock %}
