{% extends "base.html" %}

{% block title %}SIP Trunk Yönetimi - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.voip-page {
    padding: 1.5rem;
}

.page-header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

/* Trunk Cards */
.trunk-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.trunk-card {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.08);
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
}

.trunk-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
}

.trunk-header {
    padding: 1.25rem;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.trunk-name {
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.trunk-name i {
    font-size: 1.5rem;
    color: #F5A623;
}

.trunk-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.trunk-status.active {
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
}

.trunk-status.inactive {
    background: rgba(158, 158, 158, 0.2);
    color: #9e9e9e;
}

.trunk-status.error {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
}

.trunk-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.trunk-body {
    padding: 1.25rem;
}

.trunk-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.trunk-info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.trunk-info-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: #888;
    letter-spacing: 0.5px;
}

.trunk-info-value {
    font-weight: 600;
    color: #333;
    font-family: var(--font-mono);
    font-size: 0.9rem;
}

.trunk-stats {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(0,0,0,0.08);
}

.trunk-stat {
    flex: 1;
    text-align: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.trunk-stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1a1a2e;
    font-family: var(--font-display);
}

.trunk-stat-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    color: #888;
    margin-top: 0.25rem;
}

.trunk-actions {
    display: flex;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    background: #f8f9fa;
    border-top: 1px solid rgba(0,0,0,0.08);
}

.trunk-actions .btn {
    flex: 1;
    padding: 0.6rem;
    font-size: 0.8rem;
}

/* Health Indicator */
.health-bar {
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 1rem;
}

.health-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    border-radius: 2px;
    transition: width 0.5s ease;
}

.health-bar-fill.warning {
    background: linear-gradient(90deg, #FF9800, #FFC107);
}

.health-bar-fill.danger {
    background: linear-gradient(90deg, #f44336, #E91E63);
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.3s ease;
}

.modal-overlay.show .modal-content {
    transform: translateY(0);
}

.modal-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
}

.modal-header h3 i {
    color: #F5A623;
}

.modal-close {
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.modal-close:hover {
    background: rgba(255,255,255,0.2);
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

/* Form Styles */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
    font-size: 0.85rem;
}

.form-group label .required {
    color: #f44336;
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 0.9rem;
    transition: all 0.2s;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: #F5A623;
    box-shadow: 0 0 0 4px rgba(245, 166, 35, 0.1);
}

.form-control::placeholder {
    color: #aaa;
}

.form-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #eee;
}

.form-section-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #F5A623;
    letter-spacing: 1px;
    margin-bottom: 1rem;
    font-weight: 600;
}

/* Codec Select */
.codec-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.codec-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #f5f5f5;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.codec-item:hover {
    background: #eee;
}

.codec-item.selected {
    background: rgba(245, 166, 35, 0.1);
    border-color: #F5A623;
}

.codec-item input {
    display: none;
}

/* Test Result */
.test-result {
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
    display: none;
}

.test-result.show {
    display: block;
}

.test-result.success {
    background: rgba(76, 175, 80, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.3);
    color: #2E7D32;
}

.test-result.error {
    background: rgba(244, 67, 54, 0.1);
    border: 1px solid rgba(244, 67, 54, 0.3);
    color: #C62828;
}

.test-result-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.test-details {
    font-size: 0.85rem;
    font-family: var(--font-mono);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #888;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #ddd;
}

.empty-state h3 {
    color: #555;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="voip-page">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="ti ti-server-2" style="color: #F5A623;"></i>
                <span data-tr="SIP Trunk Yönetimi" data-de="SIP-Trunk-Verwaltung">SIP Trunk Yönetimi</span>
            </h1>
            <p class="page-subtitle" data-tr="VoIP sağlayıcı bağlantılarını yönetin" data-de="VoIP-Anbieter-Verbindungen verwalten">VoIP sağlayıcı bağlantılarını yönetin</p>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-secondary" onclick="refreshTrunks()">
                <i class="ti ti-refresh"></i> <span data-tr="Yenile" data-de="Aktualisieren">Yenile</span>
            </button>
            <button class="btn btn-primary" onclick="openAddTrunkModal()">
                <i class="ti ti-plus"></i> <span data-tr="Yeni Trunk Ekle" data-de="Neuen Trunk hinzufügen">Yeni Trunk Ekle</span>
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-4 gap-4 mt-4">
        <div class="stat-card" style="background: linear-gradient(145deg, #E3F2FD, #BBDEFB); border-left: 4px solid #1E88E5;">
            <div class="stat-card-inner">
                <div class="icon-3d blue"><i class="ti ti-server-2"></i></div>
                <div class="stat-content">
                    <div class="stat-value">3</div>
                    <div class="stat-label" data-tr="Toplam Trunk" data-de="Gesamt Trunks">Toplam Trunk</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="background: linear-gradient(145deg, #E8F5E9, #C8E6C9); border-left: 4px solid #43A047;">
            <div class="stat-card-inner">
                <div class="icon-3d green"><i class="ti ti-circle-check"></i></div>
                <div class="stat-content">
                    <div class="stat-value">2</div>
                    <div class="stat-label" data-tr="Aktif" data-de="Aktiv">Aktif</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="background: linear-gradient(145deg, #FFF3E0, #FFE0B2); border-left: 4px solid #F57C00;">
            <div class="stat-card-inner">
                <div class="icon-3d orange"><i class="ti ti-phone-call"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="activeCallsCount">1</div>
                    <div class="stat-label" data-tr="Aktif Çağrı" data-de="Aktive Anrufe">Aktif Çağrı</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="background: linear-gradient(145deg, #F3E5F5, #E1BEE7); border-left: 4px solid #8E24AA;">
            <div class="stat-card-inner">
                <div class="icon-3d purple"><i class="ti ti-chart-line"></i></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalChannels">0</div>
                    <div class="stat-label" data-tr="Toplam Kanal" data-de="Gesamt Kanäle">Toplam Kanal</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trunk Grid -->
    <div class="trunk-grid" id="trunkGrid">
            <!-- Demo Trunks for Germany -->
            <div class="trunk-card" data-trunk-id="1">
                <div class="trunk-header">
                    <div class="trunk-name">
                        <i class="ti ti-server-bolt"></i>
                        Sipgate Business
                    </div>
                    <div class="trunk-status active">
                        ACTIVE
                    </div>
                </div>
                <div class="trunk-body">
                    <div class="trunk-info-grid">
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Host / IP</span>
                            <span class="trunk-info-value">sipconnect.sipgate.de</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Port</span>
                            <span class="trunk-info-value">5060</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label" data-tr="Kullanıcı" data-de="Benutzer">Kullanıcı</span>
                            <span class="trunk-info-value">sipgate_user</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Transport</span>
                            <span class="trunk-info-value">UDP</span>
                        </div>
                    </div>
                    <div class="trunk-stats">
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">50</div>
                            <div class="trunk-stat-label">Max Kanal</div>
                        </div>
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">12</div>
                            <div class="trunk-stat-label" data-tr="Kullanılan" data-de="Verwendet">Kullanılan</div>
                        </div>
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">G.711</div>
                            <div class="trunk-stat-label">Codec</div>
                        </div>
                    </div>
                    <div class="health-bar">
                        <div class="health-bar-fill" style="width: 92%;"></div>
                    </div>
                </div>
                <div class="trunk-actions">
                    <button class="btn btn-info btn-sm" onclick="testTrunk(1)">
                        <i class="ti ti-phone-check"></i> Test
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="editTrunk(1)">
                        <i class="ti ti-edit"></i> <span data-tr="Düzenle" data-de="Bearbeiten">Düzenle</span>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTrunk(1)">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            </div>

            <div class="trunk-card" data-trunk-id="2">
                <div class="trunk-header">
                    <div class="trunk-name">
                        <i class="ti ti-server-bolt"></i>
                        Placetel (Cisco)
                    </div>
                    <div class="trunk-status active">
                        ACTIVE
                    </div>
                </div>
                <div class="trunk-body">
                    <div class="trunk-info-grid">
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Host / IP</span>
                            <span class="trunk-info-value">sip.placetel.de</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Port</span>
                            <span class="trunk-info-value">5060</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label" data-tr="Kullanıcı" data-de="Benutzer">Kullanıcı</span>
                            <span class="trunk-info-value">placetel_trunk</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Transport</span>
                            <span class="trunk-info-value">TLS</span>
                        </div>
                    </div>
                    <div class="trunk-stats">
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">30</div>
                            <div class="trunk-stat-label">Max Kanal</div>
                        </div>
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">8</div>
                            <div class="trunk-stat-label" data-tr="Kullanılan" data-de="Verwendet">Kullanılan</div>
                        </div>
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">G.722</div>
                            <div class="trunk-stat-label">Codec</div>
                        </div>
                    </div>
                    <div class="health-bar">
                        <div class="health-bar-fill" style="width: 88%;"></div>
                    </div>
                </div>
                <div class="trunk-actions">
                    <button class="btn btn-info btn-sm" onclick="testTrunk(2)">
                        <i class="ti ti-phone-check"></i> Test
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="editTrunk(2)">
                        <i class="ti ti-edit"></i> <span data-tr="Düzenle" data-de="Bearbeiten">Düzenle</span>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTrunk(2)">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            </div>

            <div class="trunk-card" data-trunk-id="3">
                <div class="trunk-header">
                    <div class="trunk-name">
                        <i class="ti ti-server-bolt"></i>
                        Easybell SIP Trunk
                    </div>
                    <div class="trunk-status inactive">
                        STANDBY
                    </div>
                </div>
                <div class="trunk-body">
                    <div class="trunk-info-grid">
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Host / IP</span>
                            <span class="trunk-info-value">sip.easybell.de</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Port</span>
                            <span class="trunk-info-value">5060</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label" data-tr="Kullanıcı" data-de="Benutzer">Kullanıcı</span>
                            <span class="trunk-info-value">easybell_user</span>
                        </div>
                        <div class="trunk-info-item">
                            <span class="trunk-info-label">Transport</span>
                            <span class="trunk-info-value">UDP</span>
                        </div>
                    </div>
                    <div class="trunk-stats">
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">20</div>
                            <div class="trunk-stat-label">Max Kanal</div>
                        </div>
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">0</div>
                            <div class="trunk-stat-label" data-tr="Kullanılan" data-de="Verwendet">Kullanılan</div>
                        </div>
                        <div class="trunk-stat">
                            <div class="trunk-stat-value">G.711</div>
                            <div class="trunk-stat-label">Codec</div>
                        </div>
                    </div>
                    <div class="health-bar">
                        <div class="health-bar-fill warning" style="width: 50%;"></div>
                    </div>
                </div>
                <div class="trunk-actions">
                    <button class="btn btn-info btn-sm" onclick="testTrunk(3)">
                        <i class="ti ti-phone-check"></i> Test
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="editTrunk(3)">
                        <i class="ti ti-edit"></i> <span data-tr="Düzenle" data-de="Bearbeiten">Düzenle</span>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTrunk(3)">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
            </div>
    </div>
</div>

<!-- Add/Edit Trunk Modal -->
<div class="modal-overlay" id="trunkModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="ti ti-server-2"></i> <span id="modalTitle" data-tr="Yeni SIP Trunk" data-de="Neuer SIP Trunk">Yeni SIP Trunk</span></h3>
            <button class="modal-close" onclick="closeModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <form id="trunkForm" onsubmit="saveTrunk(event)">
            <div class="modal-body">
                <input type="hidden" id="trunkId" name="trunk_id">
                
                <div class="form-section">
                    <div class="form-section-title" data-tr="Temel Bilgiler" data-de="Grundinformationen">Temel Bilgiler</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label><span data-tr="Trunk Adı" data-de="Trunk-Name">Trunk Adı</span> <span class="required">*</span></label>
                            <input type="text" class="form-control" id="trunkName" name="name" required 
                                   placeholder="z.B. Sipgate Business" 
                                   data-tr-placeholder="Örn: Sipgate Business" 
                                   data-de-placeholder="z.B. Sipgate Business">
                        </div>
                        <div class="form-group">
                            <label data-tr="Sağlayıcı" data-de="Anbieter">Sağlayıcı</label>
                            <select class="form-control" id="trunkProvider" name="provider">
                                <option value="" data-tr="Seçiniz" data-de="Auswählen">Seçiniz</option>
                                <option value="sipgate">Sipgate (Deutschland)</option>
                                <option value="placetel">Placetel (Cisco)</option>
                                <option value="easybell">Easybell</option>
                                <option value="fonial">Fonial</option>
                                <option value="1und1">1&1 Versatel</option>
                                <option value="deutsche_telekom">Deutsche Telekom</option>
                                <option value="vodafone_de">Vodafone Deutschland</option>
                                <option value="nfon">NFON</option>
                                <option value="3cx">3CX Hosted</option>
                                <option value="other" data-tr="Diğer" data-de="Andere">Diğer</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title" data-tr="Bağlantı Bilgileri" data-de="Verbindungsdaten">Bağlantı Bilgileri</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Host / IP <span class="required">*</span></label>
                            <input type="text" class="form-control" id="trunkHost" name="host" required 
                                   placeholder="sip.anbieter.de oder IP"
                                   data-tr-placeholder="sip.saglayici.com veya IP"
                                   data-de-placeholder="sip.anbieter.de oder IP">
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" class="form-control" id="trunkPort" name="port" value="5060" placeholder="5060">
                        </div>
                        <div class="form-group">
                            <label data-tr="Kullanıcı Adı" data-de="Benutzername">Kullanıcı Adı</label>
                            <input type="text" class="form-control" id="trunkUsername" name="username" 
                                   placeholder="SIP Benutzername"
                                   data-tr-placeholder="SIP kullanıcı adı"
                                   data-de-placeholder="SIP Benutzername">
                        </div>
                        <div class="form-group">
                            <label data-tr="Şifre" data-de="Passwort">Şifre</label>
                            <input type="password" class="form-control" id="trunkPassword" name="password" 
                                   placeholder="SIP Passwort"
                                   data-tr-placeholder="SIP şifresi"
                                   data-de-placeholder="SIP Passwort">
                        </div>
                        <div class="form-group">
                            <label><span data-tr="Auth Kullanıcı (varsa)" data-de="Auth-Benutzer (falls vorhanden)">Auth Kullanıcı (varsa)</span></label>
                            <input type="text" class="form-control" id="trunkAuthUser" name="auth_user" 
                                   placeholder="Auth Benutzer"
                                   data-tr-placeholder="Auth kullanıcı"
                                   data-de-placeholder="Auth Benutzer">
                        </div>
                        <div class="form-group">
                            <label>Transport</label>
                            <select class="form-control" id="trunkTransport" name="transport">
                                <option value="udp">UDP</option>
                                <option value="tcp">TCP</option>
                                <option value="tls">TLS (Empfohlen)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title" data-tr="Codec ve Kapasite" data-de="Codec und Kapazität">Codec ve Kapasite</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label data-tr="Codec Seçimi" data-de="Codec-Auswahl">Codec Seçimi</label>
                            <div class="codec-list" id="codecList">
                                <label class="codec-item selected">
                                    <input type="checkbox" name="codecs" value="g711u" checked> G.711 μ-law
                                </label>
                                <label class="codec-item selected">
                                    <input type="checkbox" name="codecs" value="g711a" checked> G.711 A-law
                                </label>
                                <label class="codec-item">
                                    <input type="checkbox" name="codecs" value="g722"> G.722 HD
                                </label>
                                <label class="codec-item">
                                    <input type="checkbox" name="codecs" value="g729"> G.729
                                </label>
                                <label class="codec-item">
                                    <input type="checkbox" name="codecs" value="opus"> Opus
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-tr="Max Eşzamanlı Kanal" data-de="Max gleichzeitige Kanäle">Max Eşzamanlı Kanal</label>
                            <input type="number" class="form-control" id="trunkMaxChannels" name="max_channels" value="30" min="1" max="1000">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title" data-tr="Gelişmiş Ayarlar" data-de="Erweiterte Einstellungen">Gelişmiş Ayarlar</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Outbound Proxy</label>
                            <input type="text" class="form-control" id="trunkProxy" name="outbound_proxy" 
                                   placeholder="proxy.anbieter.de"
                                   data-tr-placeholder="proxy.saglayici.com"
                                   data-de-placeholder="proxy.anbieter.de">
                        </div>
                        <div class="form-group">
                            <label data-tr="Failover Trunk" data-de="Failover-Trunk">Failover Trunk</label>
                            <select class="form-control" id="trunkFailover" name="failover_trunk_id">
                                <option value="" data-tr="Yok" data-de="Keine">Yok</option>
                                <option value="1">Sipgate Business</option>
                                <option value="2">Placetel (Cisco)</option>
                                <option value="3">Easybell SIP Trunk</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label><span data-tr="IP Whitelist (virgülle ayırın)" data-de="IP-Whitelist (kommagetrennt)">IP Whitelist (virgülle ayırın)</span></label>
                            <input type="text" class="form-control" id="trunkWhitelist" name="ip_whitelist" placeholder="192.168.1.1, 10.0.0.0/24">
                        </div>
                    </div>
                </div>

                <!-- Test Result -->
                <div class="test-result" id="testResult">
                    <div class="test-result-header">
                        <i class="ti ti-circle-check"></i>
                        <span id="testResultTitle">Test Başarılı</span>
                    </div>
                    <div class="test-details" id="testResultDetails">
                        Bağlantı süresi: 45ms | Codec: G.711 | Kayıt: Başarılı
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="testTrunkConnection()">
                    <i class="ti ti-phone-check"></i> <span data-tr="Bağlantı Test Et" data-de="Verbindung testen">Bağlantı Test Et</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()" data-tr="İptal" data-de="Abbrechen">İptal</button>
                <button type="submit" class="btn btn-primary">
                    <i class="ti ti-device-floppy"></i> <span data-tr="Kaydet" data-de="Speichern">Kaydet</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Get current language
function getCurrentLang() {
    return localStorage.getItem('selectedLang') || 'tr';
}

// Translation helper
const translations = {
    tr: {
        newTrunk: 'Yeni SIP Trunk',
        editTrunk: 'Trunk Düzenle',
        trunkSaved: 'Trunk başarıyla kaydedildi',
        trunkDeleted: 'Trunk silindi',
        error: 'Bir hata oluştu',
        connectionError: 'Bağlantı hatası',
        deleteConfirm: 'Bu trunk\'ı silmek istediğinizden emin misiniz?',
        trunkInfoError: 'Trunk bilgileri alınamadı',
        deleteError: 'Silme hatası',
        testRunning: 'Test çağrısı yapılıyor...',
        testSuccess: 'Test başarılı! Gecikme:',
        testFailed: 'Test başarısız:',
        testError: 'Test hatası',
        connectionTesting: 'Bağlantı Test Ediliyor...',
        pleaseWait: 'Lütfen bekleyin...',
        testSuccessTitle: 'Test Başarılı',
        testFailedTitle: 'Test Başarısız',
        connectionTime: 'Bağlantı süresi',
        registration: 'Kayıt: Başarılı',
        timeoutError: 'Hata: Bağlantı zaman aşımı'
    },
    de: {
        newTrunk: 'Neuer SIP Trunk',
        editTrunk: 'Trunk bearbeiten',
        trunkSaved: 'Trunk erfolgreich gespeichert',
        trunkDeleted: 'Trunk gelöscht',
        error: 'Ein Fehler ist aufgetreten',
        connectionError: 'Verbindungsfehler',
        deleteConfirm: 'Sind Sie sicher, dass Sie diesen Trunk löschen möchten?',
        trunkInfoError: 'Trunk-Informationen konnten nicht abgerufen werden',
        deleteError: 'Löschfehler',
        testRunning: 'Testanruf wird durchgeführt...',
        testSuccess: 'Test erfolgreich! Latenz:',
        testFailed: 'Test fehlgeschlagen:',
        testError: 'Testfehler',
        connectionTesting: 'Verbindung wird getestet...',
        pleaseWait: 'Bitte warten...',
        testSuccessTitle: 'Test Erfolgreich',
        testFailedTitle: 'Test Fehlgeschlagen',
        connectionTime: 'Verbindungszeit',
        registration: 'Registrierung: Erfolgreich',
        timeoutError: 'Fehler: Verbindungs-Timeout'
    }
};

function t(key) {
    const lang = getCurrentLang();
    return translations[lang][key] || translations['tr'][key];
}

// Modal functions
function openAddTrunkModal() {
    document.getElementById('modalTitle').textContent = t('newTrunk');
    document.getElementById('trunkForm').reset();
    document.getElementById('trunkId').value = '';
    document.getElementById('testResult').classList.remove('show');
    document.getElementById('trunkModal').classList.add('show');
}

function closeModal() {
    document.getElementById('trunkModal').classList.remove('show');
}

// Codec selection
document.querySelectorAll('.codec-item').forEach(item => {
    item.addEventListener('click', function() {
        const checkbox = this.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        this.classList.toggle('selected', checkbox.checked);
    });
});

// Save trunk
async function saveTrunk(event) {
    event.preventDefault();
    
    const form = document.getElementById('trunkForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Collect codecs
    const codecs = [];
    document.querySelectorAll('input[name="codecs"]:checked').forEach(cb => {
        codecs.push(cb.value);
    });
    data.codecs = codecs.join(',');
    
    // Simulate save (demo mode)
    showNotification(t('trunkSaved'), 'success');
    closeModal();
    location.reload();
}

// Edit trunk - Demo data for German providers
const demoTrunks = {
    1: { id: 1, name: 'Sipgate Business', provider: 'sipgate', host: 'sipconnect.sipgate.de', port: 5060, username: 'sipgate_user', transport: 'udp', max_channels: 50 },
    2: { id: 2, name: 'Placetel (Cisco)', provider: 'placetel', host: 'sip.placetel.de', port: 5060, username: 'placetel_trunk', transport: 'tls', max_channels: 30 },
    3: { id: 3, name: 'Easybell SIP Trunk', provider: 'easybell', host: 'sip.easybell.de', port: 5060, username: 'easybell_user', transport: 'udp', max_channels: 20 }
};

function editTrunk(trunkId) {
    const trunk = demoTrunks[trunkId];
    if (!trunk) {
        showNotification(t('trunkInfoError'), 'error');
        return;
    }
    
    document.getElementById('modalTitle').textContent = t('editTrunk');
    document.getElementById('trunkId').value = trunk.id;
    document.getElementById('trunkName').value = trunk.name;
    document.getElementById('trunkProvider').value = trunk.provider || '';
    document.getElementById('trunkHost').value = trunk.host;
    document.getElementById('trunkPort').value = trunk.port || 5060;
    document.getElementById('trunkUsername').value = trunk.username || '';
    document.getElementById('trunkPassword').value = '';
    document.getElementById('trunkTransport').value = trunk.transport || 'udp';
    document.getElementById('trunkMaxChannels').value = trunk.max_channels || 30;
    
    document.getElementById('trunkModal').classList.add('show');
}

// Delete trunk
function deleteTrunk(trunkId) {
    if (!confirm(t('deleteConfirm'))) return;
    
    showNotification(t('trunkDeleted'), 'success');
    document.querySelector(`[data-trunk-id="${trunkId}"]`).remove();
}

// Test trunk
function testTrunk(trunkId) {
    showNotification(t('testRunning'), 'info');
    
    // Simulate test
    setTimeout(() => {
        const success = Math.random() > 0.15;
        if (success) {
            const latency = Math.floor(Math.random() * 40 + 15);
            showNotification(`${t('testSuccess')} ${latency}ms`, 'success');
        } else {
            showNotification(`${t('testFailed')} Timeout`, 'error');
        }
    }, 1500);
}

// Test connection from modal
function testTrunkConnection() {
    const testResult = document.getElementById('testResult');
    testResult.className = 'test-result show success';
    document.getElementById('testResultTitle').textContent = t('connectionTesting');
    document.getElementById('testResultDetails').textContent = t('pleaseWait');
    
    // Simulate test
    setTimeout(() => {
        const success = Math.random() > 0.2;
        if (success) {
            testResult.className = 'test-result show success';
            const latency = Math.floor(Math.random() * 50 + 20);
            document.getElementById('testResultTitle').innerHTML = `<i class="ti ti-circle-check"></i> ${t('testSuccessTitle')}`;
            document.getElementById('testResultDetails').textContent = `${t('connectionTime')}: ${latency}ms | ${t('registration')}`;
        } else {
            testResult.className = 'test-result show error';
            document.getElementById('testResultTitle').innerHTML = `<i class="ti ti-circle-x"></i> ${t('testFailedTitle')}`;
            document.getElementById('testResultDetails').textContent = t('timeoutError');
        }
    }, 2000);
}

function refreshTrunks() {
    location.reload();
}

function showNotification(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    `;
    
    if (type === 'success') {
        toast.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
    } else if (type === 'error') {
        toast.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
    } else {
        toast.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
    }
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Update stats periodically (simulated)
let activeCallCount = 1;
setInterval(() => {
    // Simulate real-time updates with realistic fluctuation
    activeCallCount = Math.max(0, Math.min(25, activeCallCount + Math.floor(Math.random() * 5) - 2));
    document.getElementById('activeCallsCount').textContent = activeCallCount;
    
    // Update total channels
    const totalChannels = 12 + 8 + (activeCallCount > 10 ? 5 : 0);
    document.getElementById('totalChannels').textContent = totalChannels;
}, 5000);

// Initialize total channels
document.getElementById('totalChannels').textContent = '20';
</script>
{% endblock %}




