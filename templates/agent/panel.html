{% extends "base.html" %}

{% block title %}Agent Paneli - AI BEE CC{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="ti ti-headset"></i>
            Agent Paneli
        </h1>
        <p class="page-subtitle">Hos geldin, {{ current_user.full_name or current_user.username }}</p>
    </div>
    <div class="page-header-actions">
        <div class="agent-status-selector">
            <select class="form-control" id="agentStatus" onchange="changeStatus(this.value)">
                <option value="available" {% if current_user.status == 'available' %}selected{% endif %}>Musait</option>
                <option value="busy" {% if current_user.status == 'busy' %}selected{% endif %}>Mesgul</option>
                <option value="break" {% if current_user.status == 'break' %}selected{% endif %}>Mola</option>
                <option value="wrap_up" {% if current_user.status == 'wrap_up' %}selected{% endif %}>Islem Sonrasi</option>
            </select>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon"><i class="ti ti-phone-call"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="statCalls">0</div>
                <div class="stat-label">Bugunku Cagrilar</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="stat-icon"><i class="ti ti-shopping-cart"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="statSales">0</div>
                <div class="stat-label">Bugunku Satis</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-icon"><i class="ti ti-clock"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="statCallbacks">0</div>
                <div class="stat-label">Geri Arama</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="stat-icon"><i class="ti ti-target"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="statQa">--%</div>
                <div class="stat-label">QA Skoru</div>
            </div>
        </div>
    </div>
</div>

<!-- Aktif Cagri Alani -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title"><i class="ti ti-phone"></i> Aktif Cagri</h3>
                <button class="btn btn-primary btn-lg" id="btnStartCall" onclick="getNextLead()">
                    <i class="ti ti-phone-plus"></i> Arama Baslat
                </button>
            </div>
            <div class="card-body">
                <!-- Bekleme Durumu -->
                <div class="no-call-state" id="noCallState">
                    <i class="ti ti-phone-off" style="font-size: 4rem; color: var(--text-muted);"></i>
                    <h4 style="color: var(--text-muted); margin-top: 1rem;">Aktif cagri yok</h4>
                    <p style="color: var(--text-muted);">Arama Baslat butonuna basin</p>
                </div>
                
                <!-- Aktif Cagri Bilgileri -->
                <div class="active-call-state" id="activeCallState" style="display: none;">
                    <div class="customer-card">
                        <div class="customer-header">
                            <div class="customer-avatar" id="customerAvatar">--</div>
                            <div class="customer-info">
                                <h2 id="customerName">Musteri Adi</h2>
                                <div class="customer-phone" id="customerPhone">+49 *** **** **</div>
                            </div>
                            <div class="call-timer">
                                <div class="timer-display" id="callTimer">00:00</div>
                                <div class="call-status" id="callStatus">Baglaniyor...</div>
                            </div>
                        </div>
                        
                        <div class="customer-details">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">E-posta</div>
                                    <div class="detail-value" id="customerEmail">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Sirket</div>
                                    <div class="detail-value" id="customerCompany">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Adres</div>
                                    <div class="detail-value" id="customerAddress">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">IBAN</div>
                                    <div class="detail-value masked" id="customerIban">****</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disposition Butonlari -->
                        <div class="disposition-buttons">
                            <h4><i class="ti ti-clipboard-check"></i> Arama Sonucu</h4>
                            <div class="disposition-grid">
                                <button class="btn btn-success btn-lg disposition-btn" onclick="completeCall('sale_ok')">
                                    <i class="ti ti-check"></i> SATIS OK
                                </button>
                                <button class="btn btn-warning btn-lg disposition-btn" onclick="showCallbackModal()">
                                    <i class="ti ti-clock"></i> GERI ARAMA
                                </button>
                                <button class="btn btn-secondary btn-lg disposition-btn" onclick="completeCall('no_answer')">
                                    <i class="ti ti-phone-off"></i> CEVAP YOK
                                </button>
                                <button class="btn btn-danger btn-lg disposition-btn" onclick="completeCall('no_interest')">
                                    <i class="ti ti-x"></i> ILGILENMIYOR
                                </button>
                                <button class="btn btn-dark btn-lg disposition-btn" onclick="completeCall('wrong_number')">
                                    <i class="ti ti-phone-x"></i> YANLIS NUMARA
                                </button>
                                <button class="btn btn-outline-danger btn-lg disposition-btn" onclick="completeCall('blacklist')">
                                    <i class="ti ti-ban"></i> KARA LISTE
                                </button>
                            </div>
                        </div>
                        
                        <!-- Notlar -->
                        <div class="notes-section mt-3">
                            <label class="form-label">Notlar</label>
                            <textarea class="form-control" id="callNotes" rows="2" placeholder="Cagri ile ilgili notlariniz..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="ti ti-robot"></i> AI Asistan</h3>
            </div>
            <div class="card-body">
                <div class="ai-suggestions" id="aiSuggestions">
                    <p style="color: var(--text-muted); text-align: center;">
                        <i class="ti ti-brain" style="font-size: 2rem;"></i><br>
                        Cagri basladiginda AI onerileri burada gorunecek
                    </p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title"><i class="ti ti-script"></i> Script</h3>
            </div>
            <div class="card-body">
                <div class="script-content" id="scriptContent">
                    <p style="color: var(--text-muted);">Cagri basladiginda script burada gorunecek</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Geri Arama Modal -->
<div class="modal fade" id="callbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="ti ti-clock"></i> Geri Arama Planla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Tarih</label>
                    <input type="date" class="form-control" id="callbackDate">
                </div>
                <div class="mb-3">
                    <label class="form-label">Saat</label>
                    <input type="time" class="form-control" id="callbackTime">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Iptal</button>
                <button type="button" class="btn btn-primary" onclick="saveCallback()">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<style>
.agent-status-selector select {
    background: var(--bg-card);
    border: 2px solid var(--primary);
    color: var(--text-primary);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
}
.no-call-state { text-align: center; padding: 3rem; }
.customer-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.customer-header { background: linear-gradient(135deg, #f7b731 0%, #f5a623 100%); padding: 1.5rem 2rem; color: #333; display: flex; align-items: center; gap: 1.5rem; }
.customer-avatar { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; }
.customer-info h2 { font-size: 1.5rem; margin-bottom: 0.25rem; }
.customer-phone { font-family: monospace; font-size: 1.2rem; letter-spacing: 1px; }
.call-timer { margin-left: auto; text-align: center; }
.timer-display { font-size: 2.5rem; font-weight: 700; font-family: monospace; }
.call-status { font-size: 0.85rem; }
.customer-details { padding: 1.5rem 2rem; }
.detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.detail-item { padding: 1rem; background: #f8f9fa; border-radius: 12px; }
.detail-label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem; }
.detail-value { font-weight: 600; color: #333; }
.detail-value.masked { font-family: monospace; letter-spacing: 2px; color: #666; }
.disposition-buttons { padding: 1.5rem 2rem; border-top: 1px solid #eee; }
.disposition-buttons h4 { margin-bottom: 1rem; color: #333; }
.disposition-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
.disposition-btn { padding: 1rem; font-weight: 600; }
.notes-section { padding: 0 2rem 1.5rem; }
#btnStartCall { animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
</style>

<script>
let currentLead = null;
let callStartTime = null;
let timerInterval = null;

function getNextLead() {
    document.getElementById('btnStartCall').disabled = true;
    document.getElementById('btnStartCall').innerHTML = '<i class="ti ti-loader"></i> Yukleniyor...';
    
    fetch('/api/agent/next-lead')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                currentLead = data.lead;
                showCustomerCard(data.lead);
                startCallTimer();
            } else {
                alert(data.message || 'Musteri bulunamadi');
                document.getElementById('btnStartCall').disabled = false;
                document.getElementById('btnStartCall').innerHTML = '<i class="ti ti-phone-plus"></i> Arama Baslat';
            }
        })
        .catch(err => {
            alert('Hata: ' + err.message);
            document.getElementById('btnStartCall').disabled = false;
            document.getElementById('btnStartCall').innerHTML = '<i class="ti ti-phone-plus"></i> Arama Baslat';
        });
}

function showCustomerCard(lead) {
    document.getElementById('noCallState').style.display = 'none';
    document.getElementById('activeCallState').style.display = 'block';
    
    document.getElementById('customerAvatar').textContent = (lead.first_name?lead.first_name[0]:'?') + (lead.last_name?lead.last_name[0]:'');
    document.getElementById('customerName').textContent = lead.full_name || 'Bilinmiyor';
    document.getElementById('customerPhone').textContent = lead.phone || '-';
    document.getElementById('customerEmail').textContent = lead.email || '-';
    document.getElementById('customerCompany').textContent = lead.company || '-';
    
    if (lead.custom_data) {
        document.getElementById('customerAddress').textContent = lead.custom_data.address || lead.custom_data.strasse || '-';
        document.getElementById('customerIban').textContent = lead.custom_data.iban ? '****' + lead.custom_data.iban.slice(-4) : '-';
    }
    
    document.getElementById('btnStartCall').innerHTML = '<i class="ti ti-phone-incoming"></i> Aktif Cagri';
}

function startCallTimer() {
    callStartTime = new Date();
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((new Date() - callStartTime) / 1000);
        const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const secs = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = mins + ':' + secs;
    }, 1000);
    document.getElementById('callStatus').textContent = 'Gorusme Aktif';
}

function completeCall(disposition) {
    if (!currentLead) return;
    
    const notes = document.getElementById('callNotes').value;
    
    fetch('/api/agent/complete-call', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            lead_id: currentLead.id,
            disposition: disposition,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resetCallState();
            updateStats();
        } else {
            alert(data.message || 'Hata olustu');
        }
    });
}

function showCallbackModal() {
    const modal = new bootstrap.Modal(document.getElementById('callbackModal'));
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('callbackDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('callbackTime').value = '10:00';
    modal.show();
}

function saveCallback() {
    if (!currentLead) return;
    
    const notes = document.getElementById('callNotes').value;
    const callbackDate = document.getElementById('callbackDate').value;
    const callbackTime = document.getElementById('callbackTime').value;
    
    fetch('/api/agent/complete-call', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            lead_id: currentLead.id,
            disposition: 'callback',
            notes: notes,
            callback_date: callbackDate,
            callback_time: callbackTime
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('callbackModal')).hide();
            resetCallState();
            updateStats();
        }
    });
}

function resetCallState() {
    currentLead = null;
    if (timerInterval) clearInterval(timerInterval);
    
    document.getElementById('noCallState').style.display = 'block';
    document.getElementById('activeCallState').style.display = 'none';
    document.getElementById('callTimer').textContent = '00:00';
    document.getElementById('callNotes').value = '';
    document.getElementById('btnStartCall').disabled = false;
    document.getElementById('btnStartCall').innerHTML = '<i class="ti ti-phone-plus"></i> Arama Baslat';
}

function updateStats() {
    fetch('/api/agent/stats')
        .then(r => r.json())
        .then(data => {
            document.getElementById('statCalls').textContent = data.total_calls || 0;
            document.getElementById('statSales').textContent = data.total_sales || 0;
            document.getElementById('statCallbacks').textContent = data.callbacks || 0;
        });
}

function changeStatus(status) {
    fetch('/agent/status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: status})
    });
}

// Sayfa yuklendiginde istatistikleri guncelle
document.addEventListener('DOMContentLoaded', updateStats);
</script>
{% endblock %}
