{% extends "base.html" %}

{% block title %}QC Dinleme Paneli - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
.qc-panel { padding: 1.5rem; }

/* Stats Grid */
.qc-stats-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

.qc-stat-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    border-top: 4px solid #ddd;
    transition: transform 0.2s;
}

.qc-stat-card:hover { transform: translateY(-3px); }
.qc-stat-card.total { border-top-color: #2196F3; }
.qc-stat-card.pending { border-top-color: #FF9800; }
.qc-stat-card.ok { border-top-color: #4CAF50; }
.qc-stat-card.termin { border-top-color: #9C27B0; }
.qc-stat-card.storno { border-top-color: #f44336; }

.qc-stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    font-family: var(--font-display);
}

.qc-stat-card.total .qc-stat-value { color: #2196F3; }
.qc-stat-card.pending .qc-stat-value { color: #FF9800; }
.qc-stat-card.ok .qc-stat-value { color: #4CAF50; }
.qc-stat-card.termin .qc-stat-value { color: #9C27B0; }
.qc-stat-card.storno .qc-stat-value { color: #f44336; }

.qc-stat-label {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

/* Main Content Grid */
.qc-content-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 1.5rem;
}

/* Recording List */
.recording-list-panel {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
}

.panel-header {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-title {
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.panel-body {
    padding: 0;
}

/* Recording Item */
.recording-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.2s;
}

.recording-item:hover {
    background: #f8f9fa;
}

.recording-item.active {
    background: #E8F5E9;
    border-left: 4px solid #4CAF50;
}

.recording-item.reviewed {
    opacity: 0.6;
}

.recording-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.recording-id {
    font-weight: 700;
    color: #333;
}

.recording-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.recording-status.pending { background: #FFF3E0; color: #FF9800; }
.recording-status.ok { background: #E8F5E9; color: #4CAF50; }
.recording-status.termin { background: #F3E5F5; color: #9C27B0; }
.recording-status.storno { background: #FFEBEE; color: #f44336; }

.recording-info {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    color: #666;
}

.recording-info span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Customer Detail Panel */
.customer-detail-panel {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
    position: sticky;
    top: 1rem;
}

.customer-header {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.customer-name {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.customer-phone {
    opacity: 0.9;
    font-size: 0.9rem;
}

.customer-body {
    padding: 1.5rem;
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.info-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 10px;
}

.info-label {
    font-size: 0.75rem;
    color: #888;
    margin-bottom: 0.25rem;
}

.info-value {
    font-weight: 600;
    color: #333;
}

/* Audio Players */
.audio-section {
    margin-bottom: 1.5rem;
}

.audio-title {
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.audio-title i {
    color: #4CAF50;
}

.audio-player-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.audio-player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.audio-type {
    font-weight: 600;
    font-size: 0.85rem;
}

.audio-type.system { color: #2196F3; }
.audio-type.agent { color: #9C27B0; }

.audio-duration {
    font-size: 0.8rem;
    color: #666;
}

.audio-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.play-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    transition: all 0.2s;
}

.play-btn:hover {
    transform: scale(1.1);
}

.audio-progress {
    flex: 1;
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    overflow: hidden;
}

.audio-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    width: 0%;
    transition: width 0.1s;
}

/* QC Action Buttons */
.qc-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.qc-btn {
    padding: 1rem;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.qc-btn i {
    font-size: 1.5rem;
}

.qc-btn.ok {
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
}

.qc-btn.termin {
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    color: white;
}

.qc-btn.storno {
    background: linear-gradient(135deg, #f44336, #D32F2F);
    color: white;
}

.qc-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.qc-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Notes Section */
.notes-section {
    margin-top: 1rem;
}

.notes-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.notes-textarea:focus {
    outline: none;
    border-color: #4CAF50;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: #888;
}

.empty-state i {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 1rem;
}

/* Filter Bar */
.filter-bar {
    display: flex;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
}

.filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 20px;
    background: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.filter-btn:hover {
    border-color: #4CAF50;
}

.filter-btn.active {
    background: #4CAF50;
    color: white;
    border-color: #4CAF50;
}

/* Agent Info */
.agent-info-bar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #E3F2FD;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.agent-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.85rem;
}

.agent-details {
    flex: 1;
}

.agent-name {
    font-weight: 600;
    font-size: 0.9rem;
}

.agent-team {
    font-size: 0.75rem;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
<div class="qc-panel">
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="ti ti-headphones" style="color: #4CAF50;"></i>
                <span data-tr="QC Dinleme Paneli" data-de="QC Anhörungspanel">QC Dinleme Paneli</span>
            </h1>
            <p class="page-subtitle" data-tr="Ses kayıtlarını dinle ve değerlendir" data-de="Aufnahmen anhören und bewerten">Ses kayıtlarını dinle ve değerlendir</p>
        </div>
        <div class="page-header-actions">
            <span style="background: #E8F5E9; padding: 0.5rem 1rem; border-radius: 20px; color: #2E7D32; font-weight: 600;">
                <i class="ti ti-user"></i> {{ current_user.full_name if current_user else 'QC Listener' }}
            </span>
        </div>
    </div>

    <!-- Stats -->
    <div class="qc-stats-grid">
        <div class="qc-stat-card total">
            <div class="qc-stat-value" id="statTotal">0</div>
            <div class="qc-stat-label" data-tr="Toplam Kayıt" data-de="Gesamtaufnahmen">Toplam Kayıt</div>
        </div>
        <div class="qc-stat-card pending">
            <div class="qc-stat-value" id="statPending">0</div>
            <div class="qc-stat-label" data-tr="Bekleyen" data-de="Ausstehend">Bekleyen</div>
        </div>
        <div class="qc-stat-card ok">
            <div class="qc-stat-value" id="statOk">0</div>
            <div class="qc-stat-label" data-tr="QC OK" data-de="QC OK">QC OK</div>
        </div>
        <div class="qc-stat-card termin">
            <div class="qc-stat-value" id="statTermin">0</div>
            <div class="qc-stat-label" data-tr="QC Termin" data-de="QC Termin">QC Termin</div>
        </div>
        <div class="qc-stat-card storno">
            <div class="qc-stat-value" id="statStorno">0</div>
            <div class="qc-stat-label" data-tr="QC Storno" data-de="QC Storno">QC Storno</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="qc-content-grid">
        <!-- Recording List -->
        <div class="recording-list-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="ti ti-list"></i>
                    <span data-tr="Değerlendirilecek Kayıtlar" data-de="Zu bewertende Aufnahmen">Değerlendirilecek Kayıtlar</span>
                </div>
                <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white;" onclick="refreshList()">
                    <i class="ti ti-refresh"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterRecordings('all')" data-tr="Tümü" data-de="Alle">Tümü</button>
                <button class="filter-btn" onclick="filterRecordings('pending')" data-tr="Bekleyen" data-de="Ausstehend">Bekleyen</button>
                <button class="filter-btn" onclick="filterRecordings('ok')" data-tr="OK" data-de="OK">OK</button>
                <button class="filter-btn" onclick="filterRecordings('termin')" data-tr="Termin" data-de="Termin">Termin</button>
                <button class="filter-btn" onclick="filterRecordings('storno')" data-tr="Storno" data-de="Storno">Storno</button>
            </div>
            
            <div class="panel-body" id="recordingList">
                <!-- Recording items will be loaded here -->
                <div class="empty-state">
                    <i class="ti ti-headphones-off"></i>
                    <p data-tr="Henüz kayıt yok" data-de="Noch keine Aufnahmen">Henüz kayıt yok</p>
                </div>
            </div>
        </div>

        <!-- Customer Detail -->
        <div class="customer-detail-panel" id="customerDetail" style="display: none;">
            <div class="customer-header">
                <div class="customer-name" id="customerName">-</div>
                <div class="customer-phone" id="customerPhone">-</div>
            </div>
            <div class="customer-body">
                <!-- Agent Info -->
                <div class="agent-info-bar">
                    <div class="agent-avatar" id="agentInitials">-</div>
                    <div class="agent-details">
                        <div class="agent-name" id="agentName">-</div>
                        <div class="agent-team" id="agentTeam">-</div>
                    </div>
                </div>

                <!-- Customer Info Grid -->
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label" data-tr="Tarih" data-de="Datum">Tarih</div>
                        <div class="info-value" id="callDate">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" data-tr="Süre" data-de="Dauer">Süre</div>
                        <div class="info-value" id="callDuration">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" data-tr="Proje" data-de="Projekt">Proje</div>
                        <div class="info-value" id="projectName">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" data-tr="Sonuç" data-de="Ergebnis">Sonuç</div>
                        <div class="info-value" id="callResult">-</div>
                    </div>
                </div>

                <!-- Audio Players -->
                <div class="audio-section">
                    <div class="audio-title">
                        <i class="ti ti-volume"></i>
                        <span data-tr="Ses Kayıtları" data-de="Aufnahmen">Ses Kayıtları</span>
                    </div>
                    
                    <!-- System Recording -->
                    <div class="audio-player-card">
                        <div class="audio-player-header">
                            <span class="audio-type system">
                                <i class="ti ti-phone"></i> System Recording
                            </span>
                            <span class="audio-duration" id="systemDuration">00:00</span>
                        </div>
                        <div class="audio-controls">
                            <button class="play-btn" onclick="toggleAudio('system')">
                                <i class="ti ti-player-play" id="systemPlayIcon"></i>
                            </button>
                            <div class="audio-progress">
                                <div class="audio-progress-bar" id="systemProgress"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Agent Recording -->
                    <div class="audio-player-card">
                        <div class="audio-player-header">
                            <span class="audio-type agent">
                                <i class="ti ti-microphone"></i> Agent Recording
                            </span>
                            <span class="audio-duration" id="agentDuration">00:00</span>
                        </div>
                        <div class="audio-controls">
                            <button class="play-btn" onclick="toggleAudio('agent')">
                                <i class="ti ti-player-play" id="agentPlayIcon"></i>
                            </button>
                            <div class="audio-progress">
                                <div class="audio-progress-bar" id="agentProgress"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QC Actions -->
                <div class="qc-actions">
                    <button class="qc-btn ok" onclick="qcAction('ok')" id="btnQcOk">
                        <i class="ti ti-check"></i>
                        <span>QC OK</span>
                    </button>
                    <button class="qc-btn termin" onclick="qcAction('termin')" id="btnQcTermin">
                        <i class="ti ti-phone-call"></i>
                        <span>QC TERMİN</span>
                    </button>
                    <button class="qc-btn storno" onclick="qcAction('storno')" id="btnQcStorno">
                        <i class="ti ti-x"></i>
                        <span>QC STORNO</span>
                    </button>
                </div>

                <!-- Notes -->
                <div class="notes-section">
                    <label class="info-label" data-tr="Notlar" data-de="Notizen">Notlar</label>
                    <textarea class="notes-textarea" id="qcNotes" placeholder="QC notu ekle..." data-tr-placeholder="QC notu ekle..." data-de-placeholder="QC-Notiz hinzufügen..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Empty State for Detail -->
        <div class="customer-detail-panel" id="emptyDetail">
            <div class="empty-state" style="padding: 4rem;">
                <i class="ti ti-click"></i>
                <h3 data-tr="Kayıt Seçin" data-de="Aufnahme auswählen">Kayıt Seçin</h3>
                <p data-tr="Dinlemek için soldaki listeden bir kayıt seçin" data-de="Wählen Sie eine Aufnahme aus der Liste links">Dinlemek için soldaki listeden bir kayıt seçin</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentRecordingId = null;
let audioPlaying = { system: false, agent: false };

// Filter recordings
function filterRecordings(filter) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // TODO: API call to filter recordings
    console.log('Filter:', filter);
}

// Select recording
function selectRecording(recordingId) {
    currentRecordingId = recordingId;
    
    // Update UI
    document.querySelectorAll('.recording-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`[data-recording-id="${recordingId}"]`)?.classList.add('active');
    
    // Show detail panel
    document.getElementById('emptyDetail').style.display = 'none';
    document.getElementById('customerDetail').style.display = 'block';
    
    // TODO: Load actual data from API
    // For now, show demo data
    document.getElementById('customerName').textContent = 'Max Mustermann';
    document.getElementById('customerPhone').textContent = '+49 176 *** ** 45';
    document.getElementById('agentInitials').textContent = 'TK';
    document.getElementById('agentName').textContent = 'Tuncay Karaca';
    document.getElementById('agentTeam').textContent = 'EMS - Europe Mega Service';
    document.getElementById('callDate').textContent = '03.01.2026 14:32';
    document.getElementById('callDuration').textContent = '05:42';
    document.getElementById('projectName').textContent = 'EMS';
    document.getElementById('callResult').textContent = 'SALE';
    document.getElementById('systemDuration').textContent = '05:42';
    document.getElementById('agentDuration').textContent = '02:15';
}

// Toggle audio playback
function toggleAudio(type) {
    audioPlaying[type] = !audioPlaying[type];
    const icon = document.getElementById(`${type}PlayIcon`);
    icon.className = audioPlaying[type] ? 'ti ti-player-pause' : 'ti ti-player-play';
    
    // Simulate progress
    if (audioPlaying[type]) {
        simulateProgress(type);
    }
}

function simulateProgress(type) {
    let progress = 0;
    const interval = setInterval(() => {
        if (!audioPlaying[type] || progress >= 100) {
            clearInterval(interval);
            if (progress >= 100) {
                audioPlaying[type] = false;
                document.getElementById(`${type}PlayIcon`).className = 'ti ti-player-play';
            }
            return;
        }
        progress += 1;
        document.getElementById(`${type}Progress`).style.width = progress + '%';
    }, 100);
}

// QC Action
function qcAction(action) {
    if (!currentRecordingId) return;
    
    const lang = document.documentElement.lang || 'tr';
    const notes = document.getElementById('qcNotes').value;
    
    const messages = {
        ok: { tr: 'QC OK olarak işaretlendi!', de: 'Als QC OK markiert!' },
        termin: { tr: 'QC Termin olarak işaretlendi! Agent bilgilendirilecek.', de: 'Als QC Termin markiert! Agent wird informiert.' },
        storno: { tr: 'QC Storno olarak işaretlendi! Satış iptal edildi.', de: 'Als QC Storno markiert! Verkauf storniert.' }
    };
    
    // Disable buttons during processing
    document.querySelectorAll('.qc-btn').forEach(btn => btn.disabled = true);
    
    // Simulate API call
    setTimeout(() => {
        alert(messages[action][lang]);
        
        // Mark as reviewed
        document.querySelector(`[data-recording-id="${currentRecordingId}"]`)?.classList.add('reviewed');
        
        // Update status badge
        const statusEl = document.querySelector(`[data-recording-id="${currentRecordingId}"] .recording-status`);
        if (statusEl) {
            statusEl.className = `recording-status ${action}`;
            statusEl.textContent = action.toUpperCase();
        }
        
        // Re-enable buttons
        document.querySelectorAll('.qc-btn').forEach(btn => btn.disabled = false);
        
        // Clear notes
        document.getElementById('qcNotes').value = '';
        
        // Update stats
        updateStats();
    }, 500);
}

// Update stats
function updateStats() {
    // TODO: Get actual stats from API
    document.getElementById('statOk').textContent = 
        parseInt(document.getElementById('statOk').textContent) + 1;
    document.getElementById('statPending').textContent = 
        Math.max(0, parseInt(document.getElementById('statPending').textContent) - 1);
}

// Refresh list
function refreshList() {
    location.reload();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load demo recordings for now
    const demoRecordings = [
        { id: 1, customer: 'Max Mustermann', agent: 'Tuncay K.', time: '14:32', duration: '05:42', status: 'pending' },
        { id: 2, customer: 'Hans Schmidt', agent: 'Aslı A.', time: '14:15', duration: '03:18', status: 'pending' },
        { id: 3, customer: 'Lisa Weber', agent: 'Erdoğan Ç.', time: '13:45', duration: '04:55', status: 'pending' },
    ];
    
    const listHtml = demoRecordings.map(rec => `
        <div class="recording-item" data-recording-id="${rec.id}" onclick="selectRecording(${rec.id})">
            <div class="recording-header">
                <span class="recording-id">#REC-${rec.id}</span>
                <span class="recording-status ${rec.status}">${rec.status.toUpperCase()}</span>
            </div>
            <div class="recording-info">
                <span><i class="ti ti-user"></i> ${rec.customer}</span>
                <span><i class="ti ti-headset"></i> ${rec.agent}</span>
                <span><i class="ti ti-clock"></i> ${rec.time}</span>
                <span><i class="ti ti-player-play"></i> ${rec.duration}</span>
            </div>
        </div>
    `).join('');
    
    document.getElementById('recordingList').innerHTML = listHtml || document.getElementById('recordingList').innerHTML;
    
    // Update stats
    document.getElementById('statTotal').textContent = demoRecordings.length;
    document.getElementById('statPending').textContent = demoRecordings.filter(r => r.status === 'pending').length;
});
</script>
{% endblock %}

